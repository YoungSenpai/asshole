'use strict';var trup,init,sycl,cfgo,uris,dast,perm,blak,scbr,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads tools storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var n=Registry.log,q=rea.FEATURES,ga=function(){var d=[],f=!0,g=function(d,g,c){var a={title:d.join("\n\n")};g.path=rea.extension.getURL("images/icon"+(g.frag?"_"+g.frag:"")+".png");n.warn(d.join("\n"));rea.browserAction.setIcon({path:g.path});rea.browserAction.setTitle(a);g=function(a,e,c){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:d[0],image:"info"});1<d.length&&a.items.push({name:d[1]});c({items:[a],options:{enabled:!1}})};c||rea.extension.onMessage.addListener(g)};return{run:function(){try{Registry.verify("5665").length&&(f=!1,g(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(d){f=!1,n.error(d.message)}if("chromeStorage"==q.DB.USE&&!q.DB.NO_WARNING){var B=
function(){if(!t)return window.setTimeout(B,2E3);t.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});g(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(B,
1E3)}return f},pause:g,setWarning:function(g,f,c){d.push({text:g,description:f,url:c})},getWarnings:function(){return d}}}();if(ga.run()){var m=Registry.get("promise"),w=Registry.get("helper"),ta=Registry.get("tools"),L=Registry.get("statistics"),t=Registry.get("storage"),R=Registry.get("notify"),W=Registry.get("asker"),O=Registry.get("native"),Aa=Registry.get("permission"),ha=Registry.get("layout"),z=Registry.get("uri"),d=Registry.get("i18n"),H=Registry.get("downloads"),J=ta.cache;uris=z;down=H;
perm=Aa;dast=t;var ua=w.createUUID(),P={},X={};n.debug("Starting background fred @"+ua);J.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();J.create("regexp").setOptions({timeout:3600,check_interval:120,retimeout_on_get:!0}).init();var Ba=function(){var d=m(),r,g,h=rea.extension.manifest.version,k=t.getSchemaVersion(),c=k;t.getVersion("0.0.0.0").then(function(a){g=a;r=C.versionCmp(h,g)==C.versionCmp.eNEWER;return t.isWiped()}).then(function(a){!r&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","http://tampermonkey.net/faq.php#Q207"],n.warn(a.join("\n")),ga.setWarning.apply(this,a))}).always(function(){var a=[],b=0,e=function(){if(b<a.length){var l=a[b].schema;a[b].cond(l)?a[b].fn().done(function(){l&&(n.log("Converted database from",c,"to",l),c=l);b++;e()}).fail(function(){d.reject()}):(b++,e())}},l=function(){n.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
ga.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return r&&!q.RUNTIME.FIREFOX&&!q.RUNTIME.EDGE&&"chromeStorage"==q.DB.USE&&!t.getValue(q.CONSTANTS.STORAGE.LEGACY_VERSION)&&C.versionCmp("3.5.3603",g)==C.versionCmp.eNEWER},fn:function(){var a=m();rea.extension.inIncognitoContext?(l(),a.reject()):(n.log("Update database..."),c="3.5.3603",t.migrate("sql",
"chromeStorage").done(function(){n.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return r&&C.versionCmp("3.6.3650",c)==C.versionCmp.eNEWER&&C.versionCmp("3.5.3650",g)==C.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)l(),a.reject();else{c="3.6.3650";var b=[];[{o:"TM_config",n:q.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:q.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var e=
t.getValue(a.o);void 0!==e&&b.push(t.setValue(a.n,e))}b.push(t.deleteValue(a.o))});var e=/@re$/,d=[];t.listValues().forEach(function(a){-1!=a.search(e)&&(a=a.replace(e,""),d.push(a))});d.forEach(function(a){var e=t.getValue(a+"@st"),c=t.getValue(a),l=t.getValue(a+"@re"),x=t.getValue(a+"@source"),p=y.getUidByName(a)||w.createUUID();b.push(t.deleteValue(a+"@st"));b.push(t.deleteValue(a));b.push(t.deleteValue(a+"@re"));b.push(t.deleteValue(a+"@source"));c&&l&&x?(b.push(t.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+
p,a)),b.push(t.setValue(q.CONSTANTS.PREFIX.COND+p,l)),b.push(t.setValue(q.CONSTANTS.PREFIX.STORE+p,e)),b.push(t.setValue(q.CONSTANTS.PREFIX.SCRIPT+p,x)),b.push(t.setValue(q.CONSTANTS.PREFIX.META+p,c))):n.warn("invalid script entry",{source:x,meta:c,cond:l})});e=/@st$/;t.listValues().forEach(function(a){-1!=a.search(e)&&b.push(t.deleteValue(a))});m.when(b).done(function(){n.log("Converted database from",g,"to",c);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return C.versionCmp(a,
c)==C.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)l(),a.reject();else{var b=[],e=new RegExp("^"+q.CONSTANTS.PREFIX.META);t.listValues().forEach(function(a){if(-1!=a.search(e)){var c=t.getValue(a);c.options&&c.options.override&&!c.options.override.orig_run_at&&(c.options.override.orig_run_at=c.options.run_at||"document-idle",c.options.run_at=null,b.push(t.setValue(a,c)))}});m.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4526",cond:function(a){return r&&
q.RUNTIME.SAFARI&&"chromeStorage"==q.DB.USE&&C.versionCmp(a,c)==C.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)l(),a.reject();else{n.log("Update database...");var b=t.migrate("localStorage","chromeStorage").done(function(){n.log("Copied config for default usage of setting storage")});a.consume(b)}return a.promise()}},{schema:"4871",cond:function(a){return r&&C.versionCmp(a,c)==C.versionCmp.eNEWER},fn:function(){var a=m(),b,e,c=t.getValue(q.CONSTANTS.STORAGE.CONFIG);
c&&c.scriptTemplate&&(e=f.getDefaults())&&(b=e.script_templates)&&b[0]&&b[0].value&&(b[0].value=c.scriptTemplate,delete c.scriptTemplate,t.setValue(q.CONSTANTS.STORAGE.CONFIG,c));a.resolve();return a.promise()}},{schema:"5465",cond:function(a){return C.versionCmp(a,c)==C.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)l(),a.reject();else{var b=t.getValue(q.CONSTANTS.STORAGE.CONFIG);b&&1==b.sync_version&&(b.sync_enabled=!1,t.setValue(q.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},
{cond:function(){return r||C.versionCmp(c,k)==C.versionCmp.eNEWER},fn:function(){var a=m();t.setVersion(h,c).done(function(){a.resolve()});return a.promise()}},{cond:function(){return r},fn:function(){n.log("First run of version "+h+"!");va.scheduleNotification(g,"0.0.0.0"==g);return m.Pledge()}},{cond:function(){return!0},fn:function(){var a=m();d.resolve();window.setTimeout(a.resolve,q.MISC.TIMEOUT);return a.promise()}}];e()});return d.promise()},ca=function(){return{get:function(d,r){var g=(0==
d)+"#"+r,h=J.items.rundata.getj(g);if(h)h=h.oldret;else{var h=[],k=0,c={};if(r)for(var a=v.determineScriptsToRun(r,!0),b=0;b<a.length;b++){var e=a[b];e.enabled?e.evilness&&e.evilness>=f.values.script_blacklist_severity||0!=d&&(!0===e.options.noframes||null===e.options.noframes&&!0===e.options.override.orig_noframes)||v.isContexter(e)||(c[e.name]=!0,h.push(e)):k++}h={runners:h,disabled:k,script_map:c};r&&J.items.rundata.setj(g,{frameId:d,oldret:h})}return h},answer:function(d,r){var g=w.select(d,function(a){return a}),
h=[{m:"native",t:[H.staticVars.DEFAULT,H.staticVars.NATIVE]},{m:"disabled",t:[H.staticVars.OFF]},{m:"browser",t:[H.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(f.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",k=rea.extension.inIncognitoContext,c=!k&&"off"!=f.values.external_connect&&v.validUrl(r,wa.externally_connectable_reg);return{scripts:g,contexters:ja.getContexterCount(),raw:{},external_connect:c,inIncognitoContext:k,downloadMode:h,enforce_strict_mode:"on"==
f.values.runtime_strict_mode,statistics:L.isActive("api"),measure_scripts:f.values.debug,logLevel:f.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(d,f){for(var g=[],h=v.determineScriptsToRun(f),k=0;k<h.length;k++){var c=h[k];c.enabled&&(0==d||!0!==c.options.noframes&&(null!==c.options.noframes||!0!==c.options.override.orig_noframes))&&v.isContexter(c)&&g.push(c)}return g}}}(),D=function(){var d={},r=1,g=r++,h=r++,k=r++,c=r++,a=r++,b=r++,e=r++,l=function(){var a={frames:{0:{state:g}},
tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},x={updateStats:function(a,b,e,c){d[a].stats.running+=e;d[a].stats.disabled+=c;d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a].stats.running-=e;d[a].stats.disabled-=c});d[a].tabs.ts=Date.now()},updateMaps:function(a,b,e){var c=1,
l=function(b,e){void 0===d[a].maps[e]&&1===c&&(d[a].maps[e]=0);d[a].maps[e]+=c};w.each(e,l);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&(c=-1,w.each(e,l))})},updateUrls:function(a,b,e){var c=function(c){1===c&&(void 0===d[a].urls[e]?d[a].urls[e]={frameId:b,count:0}:0===b&&(d[a].urls[e].frameId=b));d[a].urls[e].count+=c;d[a].urls.length=-1};c(1);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&
c(-1)})},determine:function(a,b,e){var c=null;U.isAllowed(e)?c=e:(n.debug("This URL is filtered by the security settings:",e,"-> Do nothing!"),D.set.forbidden(a,b));c=ca.get(b,c);d[a].scripts[e]=c;c.runners.forEach(function(e){e.webRequest&&da.scripts.set(a,b,e.uuid,e.webRequest)});return c.runners.length},run:function(a,b,e,c,l){a=[];for(b=0;b<c.length;b++)a.push(xa.bundle({url:e},c[b]));var d;m.when(a).always(function(a){l?l(a):d=a});return d}},u={},p={},A={},N={},E={listeners:{once:{whenReady:function(a,
b){if(!d[a]||d[a].frames[0].state<k)E.listeners.once.onReady(a,b);else b()},onReady:function(a,b){var e=function(a){E.listeners.remove.onCommited(c);E.listeners.remove.onCompleted(l);a&&b()},c=E.listeners.add.onCommited(function(b){b===a&&e(!0)}),l=E.listeners.add.onCompleted(function(b){b===a&&e(!0)})}},add:{onReset:function(a){var b=w.createUUID();u[b]=a;return b},onCommited:function(a){var b=w.createUUID();p[b]=a;return b},onCompleted:function(a){var b=w.createUUID();A[b]=a;return b},onRemoved:function(a){var b=
w.createUUID();N[b]=a;return b}},remove:function(){return{onReset:function(a){delete u[a]},onCommited:function(a){delete p[a]},onCompleted:function(a){delete A[a]},onRemoved:function(a){delete N[a]}}}()},events:{reset:function(a,b){var e;q.RUNTIME.FAST_EXEC_SUPPORT&&(e=d[a])&&Object.keys(e.frames).forEach(function(b){E.events.clean(a,b)});e=d[a]=l();e.frames[0].state=g;w.each(u,function(e){e&&e(a,b)})},response:function(a,b,e){if(f.values.enabled){var c=d[a]=d[a]||l(),p=c.frames[b]=c.frames[b]||{},
u=p.state||g;0===b&&(c.tabs.response_ts=Date.now());e=z.woHash(e);u<h&&(x.determine(a,b,e),p.state=h);return(a=c.scripts[e])?a.runners.length:0}},commited:function(a,b,e){if(f.values.enabled){var c=z.parse(e);if("http:"===c.protocol||"https:"===c.protocol||"file:"===c.protocol){var c=d[a]=d[a]||l(),c=c.frames[b]=c.frames[b]||{},u=c.state||g;u>=k||(c.state=k,u<h&&(e=z.woHash(e),x.determine(a,b,e)),w.each(p,function(b){b&&b(a)}))}}},loading:function(a,b,e){if(f.values.enabled){var p=z.parse(e);if(("http:"===
p.protocol||"https:"===p.protocol||"file:"===p.protocol)&&0===b&&"file:"===p.protocol){p=d[a]=d[a]||l();p.frames[b]=p.frames[b]||{};var u=p.frames[b].state||g;u>=c||(p.frames[b].state=c,u<h&&(e=z.woHash(e),x.determine(a,b,e)))}}},run:function(b,e,c,p,u){if(f.values.enabled){var g=0===e||q.RUNTIME.FAST_EXEC_SUPPORT?e:c,h=d[b]=d[b]||l();h.frames[g]=h.frames[g]||{};var A=z.woHash(p),N=h.scripts[A];if(!N&&(n.debug("tv: lazy init @ events.run("+b+", "+e+", "+c+", "+p+")"),x.determine(b,e,A),N=h.scripts[A],
!N)){n.warn("tv: no script run info for tab "+b+" @ "+A,n.D?h.scripts:"");return}c=h.frames[g].state;h.frames[g].state=a;c!=a&&(x.updateMaps(b,g,N.script_map),x.updateUrls(b,g,A),x.updateStats(b,g,N.runners.length,N.disabled));return x.run(b,e,A,N.runners,u?function(a){E.events.clean(b,g,p);u(a)}:null)}},clean:function(a,b,e){if(f.values.enabled){var c,l;if(c=d[a])e&&(e=z.woHash(e),delete c.scripts[e]),(l=D.get.objurl(a,b))&&URL.revokeObjectURL(l)}},complete:function(e,c,p){p=z.parse(p);if(f.values.enabled&&
("http:"===p.protocol||"https:"===p.protocol||"file:"===p.protocol)){if(0===c){var u=d[e]=d[e]||l();u.frames[c]=u.frames[c]||{};var x=u.frames[c].state||g;u.frames[c].state=b;if(!D.get.empty(e)&&D.get.stats(e).running){if(x<a){n.warn("tv: no script run info!");return}"file:"===p.protocol?window.setTimeout(function(){rea.tabs.sendMessage(e,{method:"onLoad",frameId:c},function(){})},500):rea.tabs.sendMessage(e,{method:"onLoad",frameId:c},function(){})}}w.each(A,function(a){a&&a(e)})}},unload:function(a,
b,c){c=0===b||q.RUNTIME.FAST_EXEC_SUPPORT?b:c;q.RUNTIME.FAST_EXEC_SUPPORT&&E.events.clean(a,b);a=d[a]=d[a]||l();a.frames[c]=a.frames[c]||{};a.frames[c].state=e;if(a.contexts.onUnload[c]){for(b=0;b<a.contexts.onUnload[c].length;b++)a.contexts.onUnload[c][b]();a.contexts.onUnload[c]=[]}},remove:function(a){var b;q.RUNTIME.FAST_EXEC_SUPPORT&&(b=d[a])&&Object.keys(b.frames).forEach(function(b){E.events.clean(a,b)});delete d[a];w.each(N,function(b){b&&b(a)})}},set:{extra:function(a,b,e,c){a=d[a]=d[a]||
l();null===b?a.extra[e]=c:(a.extra[e]=a.extra[e]||{},a.extra[e][b]=c)},objurl:function(a,b,e){E.set.extra(a,b,"objurl",e)},blocker:function(a){E.set.extra(a,null,"blocker",!0)},forbidden:function(a,b){0===b&&E.set.extra(a,null,"forbidden",!0)},requests:function(a,b,e,c){a=d[a]=d[a]||l();b=a.frames[b]=a.frames[b]||{};(b.requests=b.requests||{})[e]=c}},get:{extra:function(a,b,e,c,l){void 0===c&&(c=null);a=(d[a]?d[a].extra:{})[e];null!==b&&a&&l&&delete a[b];return a||c},empty:function(a){var b=!0;if(d[a]&&
0!=d[a].urls.length){if(-1==d[a].urls.length)return d[a].urls.length=0,w.each(d[a].urls,function(b,e){"length"!==e&&0<b.count&&d[a].urls.length++}),E.get.empty(a);b=!1}return b},urls:function(a){return d[a]?d[a].urls:{}},stats:function(a,b){var e={};if(d[a]&&(e.running=d[a].stats.running,e.disabled=d[a].stats.disabled,b)){e.unique=0;for(var c in d[a].maps)d[a].maps.hasOwnProperty(c)&&0<d[a].maps[c]&&e.unique++}return e},tabs:function(){var a={};w.each(d,function(b,e){a[e]={ts:b.response_ts}});return a},
objurl:function(a,b){return E.get.extra(a,b,"objurl",null,!0)},blocker:function(a){return E.get.extra(a,null,"blocker")},forbidden:function(a){return E.get.extra(a,null,"forbidden")},requests:function(a,b){return d[a]&&d[a].frames[b]?d[a].frames[b].requests:null}}};return E}(),oa=function(){return{isScriptUrl:function(d){if(!d||-1!=d.search(/\#bypass=true/)||-1!=d.search(q.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||"data:"===d.substr(0,5))return!1;d=d.split(/[\?#$]/)[0];var f=-1!=d.search(/.+\.user\.(js\#|js\?|js$)/)||
-1!=d.search(/.+\.tamper\.(js\#|js\?|js$)/);return f?!(-1!=d.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=d.search(/^htt[ps]{1,2}:\/\/(github|gitlab)\.com/)&&!v.determineOriginOfUrl(d)||-1!=d.search(/^htt[ps]{1,2}:\/\/bitbucket\.org/)&&!v.determineOriginOfUrl(d)):f}}}(),U=function(){return{init:function(){var d=function(){J.items.regexp.remove("PageFilter")};f.addChangeListener("forbiddenPages",d);f.addChangeListener("page_whitelist",d);f.addChangeListener("page_filter_mode",d)},isAllowed:function(d){var r=
!1,g=!1,h=0!=f.values.forbiddenPages.length,k=0!=f.values.page_whitelist.length;switch(f.values.page_filter_mode){case "black":g=h;break;case "off":break;case "white":r=k;break;default:r=k,g=h}(h=J.items.regexp.get("PageFilter"))||(h=v.regexify({inc:r?f.values.page_whitelist:void 0,exc:g?f.values.forbiddenPages:void 0}),J.items.regexp.set("PageFilter",h));return!g&&!r||v.validUrl(d,h)}}}(),S=function(){var B=function(d,h){var f=!1;if(h.length)return(f="/"==h.substr(0,1)?v.matchUrl(d,v.convertToRegExp(h)):
-1!=d.search(h))&&n.debug('black: entry "'+h+'" matched'),f},r={init:function(){var d=m(),h=function(){"server"===f.values.script_blacklist_type&&window.setTimeout(r.checkUpdate,2E4)};h();f.addChangeListener("script_blacklist_type",h);d.resolve();return d.promise()},getWarningsFor:function(g){var h=[];g&&w.each(f.values.script_blacklist_server,function(f){if(f){var c;w.each(f.rules,function(a){c|=B(g,a);return 1!=c});if(c)if(f.reasons){var a=Object.keys(f.reasons),b,e;void 0!==(b=d.getBestLocale(a))&&
(e=a[b]);h.push(f.reasons[e||"en"])}else f.reason&&h.push(f.reason)}});return h},getEvilnessOf:function(d){if("off"===f.values.script_blacklist_type)return!1;if(!d)return 0;var h=!1,k=0;w.each(f.values.require_blacklist,function(c){h|=B(d,c);return 1!=h});h?k=11:"server"===f.values.script_blacklist_type&&w.each(f.values.script_blacklist_server,function(c){if(c&&(w.each(c.rules,function(a){h|=B(d,a);return 1!=h}),h))return k=c.severity,!1});return Number(k)},checkUpdate:function(d){var h=m(),B=Y.getConfig(),
c;if(d||6048E5<Date.now()-B.black.last){var a=function(a,e){var c=m();pa({method:"GET",url:a,nocache:e,retries:q.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){c.resolve(a)}});return c.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(b){if(4==b.readyState&&200==b.status){try{c=JSON.parse(b.responseText).version}catch(e){n.warn("black: unable to parse version response! "+b.responseText)}n.info("black: local version: "+
B.black.version+" remote: "+c);if(c>B.black.version||d)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var e=JSON.parse(a.responseText);e&&e.blacklist&&1==e.version&&(f.values.script_blacklist_server=e.blacklist);n.info("black: updated blacklist to ",e)}catch(c){n.warn("black: blacklist update failed! ",a.responseText)}}).always(function(){B=Y.getConfig();B.black.last=Date.now();B.black.version=c||B.black.version;Y.setConfig(B);
h.resolve()})}else h.resolve();return h.promise()}};return r}();blak=S;var Ca=function(){for(var d=[],f=[],g=0;g<d.length;g++){var h=Registry.getRaw("system/"+d[g]+".tamper.js");h&&f.push(h)}return f},K=function(){var B=0,r=[],g={to:null,force:null,t:0},h={},k=ta.createQueue(1),c=function(a){return k.add(function(){n.debug("sync: import",a.uuid,a.name,a.url);var b={imported:f.values.sync_type},e={},c;for(c in p.SYNCED)!0===p.SYNCED[c]&&(e[c]=a.options[c]);var l={uuid:a.uuid,ask:!1,internal:!0,sync:b,
force_meta:{lastModified:a.lastModified,fileURL:a.url},force_options:e},d={silent_fail:!0};return G.caps.syncsSource?G.getSource(a.uuid).then(function(a){return v.installFromSource(a,l,d)}):v.installFromUrl(a.url,l,d)})},a=function(a,b){return k.add(function(){if(!G.caps.syncsSource){var e;if(!a.url||!(e=z.parse(a.url))||!e.protocol.match(/https?:/))return n.debug("sync: skip export due to missing URL",a.name,a.url),m.Pledge(!1)}n.debug("sync: export",a.name,a.url);return G.setMeta(a,{lastModified:a.lastModified}).then(function(){if(G.setSource&&
b)return G.setSource(a.uuid,b)}).then(function(){return!0})})},b=function(a){var b=a.downloadURL?a.downloadURL.split("#")[0]:null,e=a.fileURL?a.fileURL.split("#")[0]:null,c=w.select([e,b],function(a){if(!a||"file:"!==z.parse(a).protocol)return a})[0],b={uuid:a.uuid,name:a.name,options:{},durl:b,furl:e,url:c,lastModified:a.lastModified||a.lastUpdated},l;for(l in p.SYNCED)!0===p.SYNCED[l]&&null!==a.options[l]&&(b.options[l]=a.options[l]);return b},e=function(){var a=[];y.getUidList().forEach(function(e){e=
y.getByUid(e);if(e.script&&e.cond){var c=b(e.script);c.lastModified||Registry.isDevVersion("test")?a.push(c):n.warn("sync: script without updated/modified timestamps found",e.script)}});return a},l=function(b){if(p.enabled)if(0<B)b&&p.addSyncDoneCallback(function(a){a&&p.sync(50,b)});else{B++;var l=null,u=null,x=!1,g=!0,k=function(a){if(a)for(var b=0;b<u.length;b++)if(u[b].uuid==a)return u[b];return null},q=function(a){if(!a)return null;for(var b=0;b<l.length;b++)if(l[b].uuid==a)return l[b]};return m.Pledge().then(function(){l=
e();return G.list().done(function(a){u=a}).fail(function(){n.warn("sync: unable to get remotelist!")})}).then(function(){var a=u.map(function(a){var b=q(a.uuid),e,l;if(b){if(!a.lastModified&&f.values.sync_type==G.types.eCHROMESYNC)for(var u in p.SYNCED)if(!0===p.SYNCED[u]&&b.options[u]!=a.options[u]){n.debug("sync: importable change detected!",a.name,"key:",u,a);e=!0;break}a.lastModified&&a.lastModified>b.lastModified&&(l=a.lastModified,e=!0,n.debug("sync: importable change detected!",a.name,"local ts:",
new Date(b.lastModified),"remote ts:",new Date(a.lastModified),a))}if(!b||e)return function(){return m.Pledge().then(function(){return G.caps.specialMeta?G.getMeta(a.uuid):m.Pledge(a)}).then(function(a){if(a){var u;if(b)if(a.options.removed)x=!0,n.debug("sync: remove local script",a.uuid,a.name,a.url),v.doRemove(b.uuid,!1);else{if(e){l!=a.lastModified&&(a.lastModified&&n.warn("sync: list and meta data lastModified differ, this will cause extra traffic!","file ts:",new Date(l),"meta ts:",new Date(a.lastModified),
a),a.lastModified=l);x=!0;n.debug("sync: update local script",a.uuid,a.name,a.url);var g=y.getByUid(b.uuid);if(g.script&&g.cond){for(u in p.SYNCED)!0===p.SYNCED[u]&&(g.script.options[u]=a.options[u]);g.script.lastModified=a.lastModified;return m.Pledge().then(function(){if(G.caps.syncsSource)return G.getSource(a.uuid,g.script.textContent).done(function(a){g.script.textContent=a})}).then(function(){return v.doModify(g.script.uuid,g.script,!1)})}n.warn(d.getMessage("fatal_error")+"("+b.name+")!!!")}}else if(!b&&
!a.options.removed)if(u=m(),a.url&&h[a.url]||a.uuid&&h[a.uuid])n.warn("sync: skip previously failed import",a);else return c(a).done(function(b){b?x=!0:(n.warn("sync: unable to import",a),h[a.url]=!0,h[a.uuid]=!0)}).fail(function(){n.warn("sync: unable to load",a);h[a.url]=!0;h[a.uuid]=!0}).always(u.resolve),u.promise()}})}}).filter(function(a){return a});return m.onebyone(a)}).then(function(){x&&v.reorderScripts();l=e();return m.Pledge()}).then(function(){for(var b=[],e=0;e<l.length;e++)b.push(function(){var b=
l[e],c,d;if(!G.caps.syncsSource&&!b.url)return m.Pledge();var p=k(b.uuid);if(p){if(!p.lastModified||b.lastModified>p.lastModified)c=!0,n.debug("sync: exportable change detected!",b.name,"remote ts:",new Date(p.lastModified),"local ts:",new Date(b.lastModified),b)}else n.debug("sync: export because remotely missing!",b.name,"local ts:",new Date(b.lastModified),b);return!p||c?(G.caps.syncsSource&&(c=y.getByUid(b.uuid),c.script&&c.cond&&(d=c.script.textContent)),a(b,d).then(function(a){a&&(x=!0)})):
m.Pledge()}());return m.when(b)}).fail(function(){g=!1}).done(function(){g=!0}).always(function(){n.debug("sync: finished");if(0==--B)for(var a=g;r.length;)r.shift()(a)})}},x=function(){p.enabled&&p.sync(500,!0)},u=null,p={enabled:!1,SYNCED:{comment:!0},configChangeListener:function(){u||(u=window.setTimeout(function(){u=null;p.init().done(function(){p.enabled&&p.sync(3E3)})},3E3))},init:function(){var a=m();p.enabled=!1;(function(){return f.values.sync_enabled&&f.values.sync_type?G.init(f.values.sync_type).done(function(a){p.enabled=
a;p.enabled?G.addChangeListener(x):n.warn("sync: init failed!")}).fail(function(){n.warn("sync: init failed!")}):m.Pledge()})().always(function(){a.resolve(p.enabled)});return a.promise()},finalize:function(){},reset:function(){return p.enabled?G.reset():m.Breach()},addSyncDoneCallback:function(a){r.push(a)},sync:function(a,b){var e=Date.now();a=a||500;b=g.force||b;g.to?(window.clearTimeout(g.to),g.ts<e+a&&(a=g.ts-e,1>a&&(a=1))):n.debug("sync: schedule sync for run in "+a+" ms");g.force=b;g.ts=e+
a;g.to=window.setTimeout(function(){l(g.force);g.to=null;g.force=null},a)},scriptAddedCb:function(e,c){if(p.enabled){var l=b(c);a(l,c.textContent)}},scriptChangedCb:function(){p.enabled&&p.sync(6E4)},scriptRemovedCb:function(a,e){if(p.enabled){var c=b(e);n.debug("sync: remove",c.name,c.url);G.remove(c)}}};return p}();sycl=K;var Da=function(){f.addChangeListener("sync_enabled",K.configChangeListener);f.addChangeListener("sync_type",K.configChangeListener);f.addChangeListener("logLevel",function(){n.set(f.values.logLevel)});
f.addChangeListener("i18n",function(){d.setLocale(f.values.i18n)});f.addChangeListener("native_import_path",function(){O.setPath(f.values.native_import_path)});f.addChangeListener("incognito_mode",function(){ya()});f.addChangeListener("statistics_enabled",function(){L.setEnabled(f.values.statistics_enabled)});f.addChangeListener("require_blacklist",v.blackCheckAll);f.addChangeListener("script_blacklist_server",v.blackCheckAll);f.addChangeListener("script_blacklist_type",v.blackCheckAll);f.addChangeListener("downloads_extension_whitelist",
H.config_changed_listener);f.addChangeListener("downloads_mode",H.config_changed_listener);f.addChangeListener("webrequest_modHeaders",function(d,f,g,h){h.done(window.setTimeout(V.reset,1))})},f=function(){var d={},f={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",webrequest_fixContentCSP:"no",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},
{name:"ECMAScript 6",value:'// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.18.2/babel.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.16.0/polyfill.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n    /* jshint esnext: false */\n    /* jshint esversion: 6 */\n\n    // Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = Babel.transform(inline_src, { presets: [ "es2015", "es2016" ] });\neval(c.code);\n/* jshint ignore:end */'},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n    // Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",script_file_access:q.RUNTIME.FIREFOX?"off":"externals",runtime_strict_mode:"byscript",runtime_inject_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:"spaces",editor_tabMode:"indent",
editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:5E4,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,editor_trimTrailingSpacesFromModifiedLines:!0,favicon_service:"google",native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",layout_user_css:"",sync_enabled:!1,sync_type:2,
statistics_enabled:q.RUNTIME.FIREFOX&&"firb"!=rea.runtime.short_id?null:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",
script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},g=function(c){var a=t.getValue(q.CONSTANTS.STORAGE.CONFIG,{});return void 0===a[c]?
f[c]:a[c]},h=function(c,a){var b=t.getValue(q.CONSTANTS.STORAGE.CONFIG,{}),e=void 0===b[c]?f[c]:b[c];b[c]=a;var l=t.setValue(q.CONSTANTS.STORAGE.CONFIG,b);d[c]&&JSON.stringify(e)!=JSON.stringify(a)&&d[c].forEach(function(b){try{b(c,e,a,l)}catch(d){n.warn("config: changeListener error",d)}});return l},k={init:function(){var c=m();k.values={};k.__defineGetter__("snapshot",function(){return w.assign({},k.values)});for(var a in f)f.hasOwnProperty(a)&&function(){var b=a;k.values.__defineGetter__(b,function(){return g(b)});
k.values.__defineSetter__(b,function(a){h(b,a)})}();k.initialized=!0;var b=Ca();Object.keys(b).forEach(function(a){var c=b[a];window.setTimeout(function(){v.doSave({url:null,src:c,ask:!1,replace:!0,internal:!0})},1)});c.resolve();return c.promise()},getValue:g,setValue:h,getDefaults:function(){return f},addChangeListener:function(c,a){d[c]||(d[c]=[]);d[c].push(a)}};return k}(),pa=function(d,f){return ka(d,f,{internal:!0})},la=function(){var d=m();rea.tabs.getSelected(null,function(f){d.resolve(f)});
return d.promise()},ea=function(){var d={},r=function(a){var b=a.split(".");if(3>b.length||z.isIp(a))return a;a=z.isSecondLevelDomain(b.slice(-2).join("."))?-3:-2;return b.slice(a).join(".")},g=function(a){return a&&-1!=a.indexOf("*")},h=function(a){var b=m();U.isAllowed(a)?b.resolve({allowed:!0}):b.resolve({allowed:!1});return b.promise()},k=function(a,b){var e=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=z.parse(b.url).hostname||null;else if("'none'"==a)a="none";else if(-1===
["none","localhost","*"].indexOf(a)&&(1>a.indexOf(".")||1===(a.match(/\./g)||[]).length&&z.isSecondLevelDomain(a)))return null;return a}):[]};return{connects:a.options.override.merge_connects&&"paranoid"!=f.values.connect_mode?e(a.connects):[],userconnects:e(a.options.override.use_connects),blockers:e(a.options.override.use_blockers)}},c=function(a,b,e){var c=m(),l=function(){c.resolve({permitted:!0})},x=function(a){c.resolve({permitted:!1,reason:a})},h=function(){c.resolve({unknown:!0})},k,n=function(a,
b){var e=null,c=z.isIp(a);b.every(function(b){if(b.a)for(var d=0;d<b.a.length;d++)if(b.a[d]&&(c?b.a[d]===a:-1!=a.search(new RegExp("(^|.+\\.)"+w.escapeForRegExp(b.a[d])+"$"))))return e=b.blocker?x:l,!1;return!0});return e};if("off"==f.values.connect_mode)l();else if((k=z.parse(e))&&k.hostname)if((e=n(k.hostname,[{a:d[a.uuid]}]))||(e=g(d[a.uuid])?l:null))e();else if(0===b.connects.length&&0===b.userconnects.length&&0===b.blockers.length)"casual"==f.values.connect_mode?l():"strict"==f.values.connect_mode?
x("No @connects given, but strict mode enabled"):h();else if(-1!=b.connects.indexOf("none"))x("None value found");else{if("casual"!=f.values.connect_mode||g(b.blockers)||!(e=g(b.connects)?l:null))(e=g(b.userconnects)?l:null)||(e=n(k.hostname,[{a:b.blockers,blocker:!0},{a:b.connects},{a:b.userconnects}])||h);e()}else x("URL can not be parsed");return c.promise()},a=function(){var a=function(a){for(var b=0;b<e.length;b++)if(e[b].tabId===a)return e.splice(b,1)[0];return e.pop()},c;la().then(function(e){for(;!b&&
(c=a(e.id));)c.fn()})},b,e=[],l=function(c,l,x,h,f){var k,q=m(),ia=function(){q.resolve({approved:!0})},t=function(){q.resolve({forbidden:!0})};n.debug('cor: "'+c.name+'" is asking for permission to access',h,l);if((k=z.parse(h))&&k.hostname){var w=r(k.hostname),y=l.tab?l.tab.id:null;b=!0;la().then(function(a){return W.askForConnect({src_url:l.url,hostname:k.hostname,domain:w,all_domains:g(x.connects),tabid:y,active:y===a.id,timeout:f,url:h,settings_url:rea.extension.getURL("options.html")+"#nav="+
c.uuid+"+settings",connect_url:"http://tampermonkey.net/documentation.php#_connect",script:{name:c.name,uuid:c.uuid,icon:c.icon64||c.icon||rea.extension.getURL("images/txt.png")}})}).done(function(a){var b,e=a.whole_domain?w:k.hostname;a.allow?a.once?(n.debug('cor: allowing "'+c.name+'" to access',e,"once"),ia()):a.temporary?(n.debug('cor: allowing "'+c.name+'" to access',e,"temporarily"),void 0===d[c.uuid]&&(d[c.uuid]=[]),-1==d[c.uuid].indexOf(e)&&d[c.uuid].push(e),ia()):(b=ia,a.all_domains?(n.debug('cor: allowing "'+
c.name+'" to access all domains always'),c.options.override.use_connects.push("*")):(n.debug('cor: allowing "'+c.name+'" to access',e,"always"),c.options.override.use_connects.push(e),b=ia)):a.once||a.aborted?(n.debug('cor: denying "'+c.name+'" to access',e,"once"),t()):(c.options.override.use_blockers||(c.options.override.use_blockers=[]),b=t,a.all_domains?(n.debug('cor: denying "'+c.name+'" to access any domains (additional) domain'),c.options.override.use_blockers.push("*")):(n.debug('cor: denying "'+
c.name+'" to access',e,"always"),c.options.override.use_blockers.push(e)));b&&v.doModify(c.uuid,c,!1).always(b)}).fail(t).always(function(){b=!1;e.length&&window.setTimeout(a,1)})}else t();return q.promise()},x=function(a,d,A,B){var E=k(a,d),r=arguments;return h(A).then(function(b){if(!0!==b.allowed)return m.Breach("URL is blacklisted");var e,l;return(e=z.parse(A))&&e.origin&&(l=z.parse(d.url))&&l.origin&&e.origin===l.origin?m.Pledge({permitted:!0}):c(a,E,A)}).then(function(c){if(!1===c.permitted)return m.Breach("URL is not permitted"+
(c.reason?": "+c.reason:""));if(!0===c.permitted)return m.Pledge();if(0===E.connects.length||g(E.connects)){if(-1==["ask","paranoid"].indexOf(f.values.connect_mode))return m.Breach();if(g(E.blockers))return m.Breach("URL was permanently blocked by the user");if(b){n.debug('cor: queuing access permission check from "'+a.name+'" to',A,d);var h=m();e.push({tabId:d.tab?d.tab.id:null,fn:function(){h.consume(x.apply(this,r))}});return h.promise()}return l(a,d,E,A,B).then(function(a){return!0===a.approved?
m.Pledge():m.Breach("Request was blocked by the user")})}return m.Breach("URL is not a part of the @connect list")})};return{getSessionConnects:function(a){return d[a]||[]},setSessionConnects:function(a,b){d[a]=b||[]},purgeAppeals:function(a){e=e.filter(function(b){return b.tabId!==a})},exec:function(a,b,e,c){var l,d,g,h,f=a.url,k=[],B=Math.max(Math.min(a.timeout||0,6E4),2E4),m=function(){for(var a;!g&&!h&&(a=k.shift());)a()},r=function(b,e){var l='Refused to connect to "'+(e||a.url)+'": '+(b||"Blocked by @connect CORS check"),
d=ma.makeErrorResponse(l);["onerror","ondone"].forEach(function(a){if(c[a])c[a]({response:d,exception:l})})};if(!(e&&e.url&&e.tab&&a.url&&b&&(d=y.getByUid(b))&&d.script&&d.cond))return r();x(d.script,e,a.url,B).done(function(){var b={};Object.keys(c).forEach(function(a){b[a]=function(p){var u=arguments;g||(h?k.push(function(){b[a].apply(this,u)}):function(){return p&&p.finalUrl&&f!==p.finalUrl?(h=!0,x(d.script,e,p.finalUrl,B).fail(function(){g||(l&&l.abort(),g=!0,r("Request was redirected to a not whitelisted URL",
p.finalUrl),n.warn("cor: request to",f,"was redirect to a not whitelisted URL",p.finalUrl))}).always(function(){f=p.finalUrl;h=!1;k.length&&window.setTimeout(m,1)})):{always:function(a){a()}}}().always(function(){if(!g)c[a]({response:p})}))}});l=ka(a,b)}).fail(function(a){r(a);n.warn("cor: access to",f,"was denied")});return{abort:function(){g=!0;l&&l.abort()}}}}}(),qa=function(){var d=function(a){var b=[];a=new DataView(a);for(var e=0;e<a.byteLength;e+=4){var c=("00000000"+a.getUint32(e).toString(16)).slice(-8);
b.push(c)}return b.join("")},f={md5:function(a,b){return m.Pledge(I.MD5(a,b))}},g={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var b=a.toLowerCase().replace("-","");g[b]=function(){var b=function(b,e){var c=m();window.crypto.subtle.digest(a,I.str2arrbuf(b,e)).then(function(a){c.resolve(d(a))},function(){c.reject()});return c.promise()};try{return b("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return b})}catch(c){return m.Breach()}}});var h=function(a){return-1!=
Object.keys(f).indexOf(a)},k=function(a){return function(){if(!1!==c){var b=arguments,e=m();c.push(function(){e.consume(a.apply(this,b))});return e.promise()}return a.apply(this,arguments)}},c=[];return{init:function(){n.D&&Object.keys(f).forEach(function(a){n.debug("sri:",a,"is supported")});return m.sidebyside(Object.keys(g).map(function(a){return g[a]().done(function(b){n.debug("sri:",a,"is supported");f[a]=b}).fail(function(){n.debug("sri:",a,"is unsupported")})})).always(function(){c.forEach(function(a){a()});
c=!1})},isSupported:k(function(a){return m.Pledge(h(a))}),getHash:k(function(a,b){var e=m();"string"===typeof a&&(a=z.parse(a));if(a&&a.hash){for(var c,g,f=a.hash.replace(/^#/,"").split(/,|;/g),p=0;p<f.length;p++)if((g=f[p].match(/([^=|:|-]+)[=|:|-](.+)/))&&3==g.length&&h(g[1])){c=g[2];if(!/^[0-9a-fA-F]+$/.exec(c)){var A;var k=decodeURIComponent(c);try{A=d(I.str2arrbuf(I.Base64.decode(k)))}catch(E){A=null}c=A||c}c={type:g[1],value:c}}e.resolve(c||(b?c:{type:"unsupported",value:""}))}else e.resolve();
return e.promise()}),check:k(function(a,b,e){return b&&a&&h(a.type)?f[a.type](b,e).then(function(b,e){return((e=b===a.value)?m.Pledge:m.Breach)(e||{type:a.type,value:b})}):m.Breach()})}}(),M=function(){var d={key:function(a,b){return q.CONSTANTS.PREFIX.EXTERNAL+w.select([a,b?I.MD5(b):null],function(a){return a}).join(":")},list:function(a){var b=new RegExp("^"+a);return w.select(t.listValues(),function(a){return-1!=a.search(b)})},set:function(a,b,e,c){a=d.key(a,b);var g={};w.each(e,function(a,b){"content"==
b&&(b="base",a=I.encodeS(a));g[b]=a});t.setValue(a,{ts:Date.now(),url:b,resource:g,modified:c})},get:function(a,b){var e=d.key(a,b),e=t.getValue(e),c;if(e&&e.resource){var g={};w.each(e.resource,function(a,b){"base"==b&&(b="content",a=I.decodeS(a));g[b]=a});c={ts:e.ts,url:e.url,data:g,modified:e.modified}}return c},clean:function(a,b){var e=d.key(a,b);t.deleteValue(e)},cleanAll:function(a,b){var e,c=d.list(d.key(a));if(b){var g={};w.each(b,function(b){b=d.key(a,b);g[b]=!0});e=[];w.each(c,function(a){g[a]||
e.push(a)})}else e=c;e.forEach(function(a){t.deleteValue(a)})}},r=function(a,b){var e=m(),c=function(c){var d={content:""};if(4!=c.readyState||200!=c.status&&0!=c.status||c.error)e.reject(d);else{for(var l,g=c.responseHeaders?c.responseHeaders.split("\n"):[],x,f=0;f<g.length;f++){var h=g[f].split(":"),u=h.shift()||"",h=h.join(":")||"";if("content-type"==u.trim().toLowerCase()&&(x=h.match("(image/|text/)([.-a-zA-Z0-9]+)"))){l=x[0];break}}l||(a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?l="image/x-icon":
(x=a.match(".*.(gif|png)+($|\\?|#).*"))?l="image/"+x[1]:-1!=a.search(".*.(js)+($|\\?|#).*")?l="text/javascript":(x=a.match(".*.(css|html|xml)+($|\\?|#).*"))?l="text/"+x[1]:w.isLocalImage(a)&&(l="image/x-icon"));d.meta=l;d.content=I.arrbuf2str(c.response,b.encoding);e.resolve(d)}},d=function(){e.reject({})},g=z.parse(a);-1!=["file:",q.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(g.protocol)?"file:"!=g.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&-1!=["externals","all"].indexOf(f.values.script_file_access)?
rea.file.get(a,function(a){c({readyState:4,status:0,response:a})},function(a){d({error:!0,responseText:a})}):(n.warn("externals:","Access to this local file is forbidden!","Loading the following @resource failed:",a,"-> more info:","http://tampermonkey.net/faq.php#Q204"),d({error:!0,responseText:"Access to this local file is forbidden!"})):(g={method:"GET",url:a,retries:q.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:"arraybuffer"},g.timeout=f.values.require_timeout,pa(g,{onload:c,onerror:d,ontimeout:d}));
return e.promise()},g=w.getDebouncer(9E3),h=function(a,b,e){e.no_storage=!0;k(a,b,e).done(function(e){e.modified?d.set(a,b,e.resource):n.debug("externals: update.done",a,b,e)}).fail(function(e){n.warn("externals: update.failed :(",a,b,e)}).always(function(){var e=d.get(a,b);e&&e.data?d.set(a,b,e.data):n.warn("externals: should never happen!")})},k=function(a,b,e){var c=m(),x=z.parse(b),u={sync:e.sync},p;qa.getHash(x,"supported"==f.values.require_sri_mode).done(function(k){if(b)if(S.getEvilnessOf(b)>=
f.values.script_blacklist_severity)u.resource={blacklisted:!0,content:""},c.reject(u);else if("enforce"!=f.values.require_sri_mode||k)if(!e.no_storage&&"file:"!==x.protocol&&(p=d.get(a,b))){var m=d.key(a,b),E=Date.now();0<f.values.external_update_interval&&E-p.ts>f.values.external_update_interval&&!g.is(m)&&(1<f.values.external_update_interval&&g.add(m),p.modified?n.debug("externals: resource is not updated due to user modifications",b,(new Date(p.ts)).toISOString(),(new Date(E)).toISOString()):(n.debug("externals: resource needs update",
b,(new Date(p.ts)).toISOString(),(new Date(E)).toISOString()),window.setTimeout(function(){h(a,b,e)},3E3)));u.resource=p.data;u.resource.forbidden||u.resource.blacklisted?c.reject(u):c.resolve(u)}else return u.sync=!1,r(b,{encoding:e.encoding}).done(function(g){k&&(g.sri=k);var p=function(c){!e.no_storage&&x.protocol&&-1==["file:",q.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(x.protocol)&&d.set(a,b,c)};k&&-1!=["supported","given"].indexOf(f.values.require_sri_mode)?qa.check(k,g.content,e.encoding).done(function(){u.resource=
g;p(u.resource);c.resolve(u)}).fail(function(a){u.resource={forbidden:!0,sri:{mode:f.values.require_sri_mode,type:k.type,value:"invalid"},determined:a,content:""};p(u.resource);c.reject(u)}):(u.resource=g,p(u.resource),c.resolve(u))}).fail(function(e){n.debug("externals: get.failed",a,b,e);u.resource={failed:!0,content:""};c.reject(u)});else u.resource={forbidden:!0,sri:{mode:f.values.require_sri_mode},content:""},c.reject(u);else u.resource={forbidden:!0,content:""},c.reject(u)});return c.promise()},
c={setElement:function(a,b,c,l){return d.set(a,b,c,l)},getElement:function(a,b){return d.get(a,b)},cleanElement:function(a,b){return d.clean(a,b)},dropAll:function(a){d.cleanAll(a);return m.Pledge()},dropAllBut:function(a,b){d.cleanAll(a,b);return m.Pledge()},loadResources:function(a,b){var e=m();c.getResources(a,b).always(function(){e.resolve()});return e.promise()},loadRequires:function(a,b){var e=m();c.getRequires(a,b).always(function(){e.resolve()});return e.promise()},getResources:function(a,
b){var c={elements:[]},d=m(),g=[],f={sync:!0};b.forEach(function(b){var d=b.url||z.sanitize(b.unsafe_url,b.abs_url),l={name:b.name,url:d},d=k(a,d,f),h=m();d.done(function(a){a=a.resource;l.content=a.content;l.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url,"due to a SRI error"):n.warn("externals: can't load @resource",b.name,"from forbidden URL",b.unsafe_url):a.resource&&a.resource.blacklisted?
n.warn("externals: can't load @resource",b.name,"from blacklisted URL",b.unsafe_url):(n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url),l.failed=!0);l.content=null}).always(function(a){f.sync&=a.sync;c.elements.push(l);h.resolve()});g.push(h)});m.when(g).always(function(){c.sync=f.sync;d.resolve(c)});return d.promise()},getRequires:function(a,b){var c={elements:[]},d=m(),g=[],f={encoding:"UTF-8",sync:!0};w.each(b,function(b,d){var l=b.url||z.sanitize(b.unsafe_url,b.abs_url),
h={},l=k(a,l,f),r=m();l.done(function(a){h.textContent=a.resource.content||""}).fail(function(a){a=a.resource&&a.resource.forbidden?a.resource.sri?"couldn't load @require from URL "+b.unsafe_url+" due to a SRI error":"couldn't load @require from forbidden URL "+b.unsafe_url:a.resource&&a.resource.blacklisted?"couldn't load @require from blacklisted URL "+b.unsafe_url:"couldn't load @require from URL "+b.unsafe_url;h.textContent='console.warn("Tampermonkey: " + decodeURIComponent("'+encodeURIComponent(a)+
'"));\n';n.warn("externals: "+a)}).always(function(a){f.sync&=a.sync;c.elements[d]=h;r.resolve()});g.push(r)});m.when(g).always(function(){c.sync=f.sync;c.elements=c.elements.filter(function(a){return a});d.resolve(c)});return d.promise()}};return c}();exts=M;var xa=function(){var d=function(d,h,k){var c=m(),a=[];k.forEach(function(b){b=b.textContent||"";b=na.mkCompat(b,d.options.compatopts_for_requires?d:null,"off"!=f.values.runtime_strict_mode);a.push(b)});k="\n"+a.join("\n")+"\n";var b=y.getStorageByUid(d.uuid);
h=na.mkCompat(h,d,"off"!=f.values.runtime_strict_mode);if(f.values.debug){h=h.split("\n");for(var e=!1,l,x=0;x<h.length;x++)if(l=h[x],!l.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(l.match(/^\s*\/\*/)&&(e=!0),e)if(l.match(/\*\/\s*$/))e=!1;else{if(-1!=(l=l.search(/\*\//))){h[x]=w.insert(h[x],l+2,0,"debugger;");break}}else{h[x]="debugger;"+h[x];break}h=h.join("\n")}k={header:d.header,code:h,requires:k,storage:b,script:d,source_url:rea.extension.getURL("userscript.html")+
"?id="+d.uuid};c.resolve(k);return c.promise()},r={};return{bundle:function(g,f){var k,c,a=!0;if(k=r[f.uuid])return k;var b={},e="includes matches requires resources excludes connects textContent".split(" ");Object.keys(f).forEach(function(a){-1==e.indexOf(a)&&("options"==a?(b[a]=JSON.parse(JSON.stringify(f[a])),b[a].run_at=b[a].run_at||f.options.override.orig_run_at||"document-idle"):b[a]=f[a])});k=M.getResources(b.uuid,f.resources).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),
a=c.sync);b.resources=c.elements;return M.getRequires(b.uuid,f.requires)}).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=c.sync);c=c.elements;n.debug("run script "+b.name+" @ "+g.url);return d(b,f.textContent,c)}).always(function(){c=!0;delete r[b.uuid]});c||(r[b.uuid]=k);return k}}}(),za=function(){var d=rea.extension.getViews({type:"popup"});d&&d.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},Y=function(){return{getConfig:function(){var d=
{version:0,last:0},f={scripts:0},g=t.getValue(q.CONSTANTS.STORAGE.UPDATE,f);"object"!==typeof g&&(g=f);g||(g=f);void 0==g.black&&(g.black=d);void 0==g.scripts&&(g.scripts=0);return g},setConfig:function(d){d&&t.setValue(q.CONSTANTS.STORAGE.UPDATE,d)}}}(),Z=function(){var B=function(h,k){var c=0,a=0;if(h){var b=d.getMessage("Script_Update"),e=d.getMessage("Check_for_userscripts_updates")+"...";R.show(b,e,rea.extension.getURL("images/icon128.png"),1E4)}b=y.getUidList().map(function(b){var e,h,p,A,r,
E;n.info("update: check for script updates @",b);return function(){A=y.getByUid(b);if(!A.script||!A.cond)return n.warn("update: inconsistent script entry",b,A),m.Breach();var a=!f.values.scriptUpdateCheckDisabled&&!A.script.enabled&&!k||!A.script.options.check_for_updates;return k&&A.script.uuid!==k||a||!(E=v.determineSourceURL(A.script))?m.Breach():m.Pledge()}().then(function(){var a=v.determineMetaURL(A.script);if(!a)return m.Pledge();var b=m();ka({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,
timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(c){4==c.readyState&&200==c.status?r=C.processMetaHeader(c.responseText):n.warn("update: unable to find meta data @ "+a+" req.status = "+c.status);b.resolve()}});return b.promise()}).then(function(){var a=!!r,b=a&&!!r.version,c=b&&(!A.script.version||C.versionCmp(r.version,A.script.version)==C.versionCmp.eNEWER);return a&&b&&!c?m.Breach():m.Pledge()}).then(function(){return g.getScriptFromURL(E).fail(function(){n.warn("update: failed",
A.script.name,E)})}).then(function(a){var b;b=A.script.uuid;var d=C.createScriptFromSrc(a);if(!d.name||""==d.name||void 0===d.version||d.options.compat_uW_gmonkey)b=C.versionCmp.eERROR;else{var l;b=(l=y.getMetaByUid(b))?l.system?null:d.version==l.version?C.versionCmp.eEQUAL:C.versionCmp(d.version,l.version):C.versionCmp.eNEWER}return b==C.versionCmp.eNEWER?(c++,e=A.script.name,h=E,p=a,m.Pledge()):m.Breach()}).then(function(){if(f.values.notification_silentScriptUpdate)return m.Pledge();var a=d.getMessage("There_is_an_update_for_0name0_avaiable_",
e)+"\n"+d.getMessage("Click_here_to_install_it_"),b=d.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",c=m();R.show(b,a,rea.extension.getURL("images/icon128.png"),f.values.scriptUpdateHideNotificationAfter,c.resolve);return c.promise()}).then(function(c){var e=b||A.script.uuid;return void 0===c||c.clicked?v.doSave({url:h,uuid:e,replace:!e,src:p,ask:!f.values.notification_silentScriptUpdate}).done(function(b){b&&b.installed&&a++}):m.Breach()})});return m.sidebyside(b).then(function(){0==
c&&h&&(n.debug("No update found"),R.show("Narf!",d.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:c,installed:a}})},r=null,g={check:function(g,k,c){if(!g&&0>=f.values.scriptUpdateCheckPeriod)return m.Breach();var a=Y.getConfig();if(!g&&Date.now()-a.scripts<Math.max(f.values.scriptUpdateCheckPeriod,36E5))return m.Breach();var b=m();g=function(){e&&(window.clearTimeout(e),e=null);l&&l.cancel();B(k,c).done(function(a){b.resolve(a.installed)}).fail(function(){b.resolve(null)});
a=Y.getConfig();a.scripts=Date.now();Y.setConfig(a)};var e,l,x=function(){l=null;var a=d.getMessage("Script_Update"),b=d.getMessage("Waiting_for_sync_to_finish")+"...";l=R.show(a,b,rea.extension.getURL("images/icon128.png"),6E4)};K.enabled?(K.addSyncDoneCallback(g),K.sync(50,!1),k&&(e=window.setTimeout(x,500))):g();return b.promise()},getScriptFromURL:function(d){var g=m();-1!=["file:",q.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(z.parse(d).protocol)?rea.file.get(d,function(c){g.resolve(I.arrbuf2str(c))},
function(c){g.reject({error:!0,responseText:c})}):pa({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript, */*"},url:d},{onload:function(c){4!=c.readyState||200!=c.status&&0!=c.status||c.error?g.reject({error:!0,responseText:c.responseText}):g.resolve(c.responseText)},onerror:function(c){g.reject({error:!0,responseText:c.responseText})},ontimeout:function(){g.reject({timeout:!0,responseText:""})}});return g.promise()},
init:function(){var d=function(){r&&(window.clearTimeout(r),r=null);0<f.values.scriptUpdateCheckPeriod&&(r=window.setTimeout(function(){r=null;g.check();d()},36E5))};d();f.addChangeListener("scriptUpdateCheckPeriod",d)}};return g}();trup=Z;var v=function(){var B=function(c){c.sort(function(a,b){return a.position-b.position});return c},r=function(c){void 0===c.ask&&(c.ask=!0);if(void 0===c.url||null==c.url)c.url="";""===c.force_url&&(c.force_url=null);var a=C.createScriptFromSrc(c.src),b=null,e={heading:null,
errors:[],info:[],warnings:[],flags:{}},l=m(),g=Date.now(),h=c.save&&!c.ask&&f.values.editor_easySave,p=c.uuid,A,r;a.name&&void 0!=a.version?r=m.Pledge():(e.errors.push(d.getMessage("Invalid_UserScript__Sry_")+"\n\n"),c.name&&e.errors.push(d.getMessage("Script_name_0name0",c.name)+"\n\n"),c.url&&e.errors.push(d.getMessage("Downloaded_from_0url0",c.url)),n.warn("scriptman: invalid userscript",e,a),r=m.Breach());r.then(function(){c.replace&&!p&&(p=y.getUidsByName(a.name,a.namespace)[0]);if(p)b=y.getMetaByUid(p);
else if(a.uuid)p=a.uuid;else if(c.replace)p=w.createUUID();else return n.warn("scriptman: neither UUID, @uuid nor replace option set"),m.Breach();if(""!==p.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,""))return n.warn("scriptman: invalid UUID",p),m.Breach();if(!c.clean&&!c.defaultscript&&b&&b.system)return m.Breach()}).then(function(){if(c.clean&&c.name&&c.name!=a.name||-1!=a.name.search("\n"))return e.errors.push(d.getMessage("Invalid_UserScript_name__Sry_")),
m.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return e.errors.push(d.getMessage("This_script_uses_uW_gm_api_")),m.Breach()}).then(function(){if(b){b.name!=a.name&&(e.flags.renamed=!0);if(b.lastModified&&void 0!==c.lastModTime&&b.lastModified!==c.lastModTime){var l=d.getMessage("some_secs");try{var f=Math.max(1,Math.floor((g-b.lastModified)/1E3));isNaN(f)||(l=f)}catch(p){}e.warnings.push(d.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",l));e.flags.forceAsk=!0}a.version==
b.version&&(c.save?e.flags.modification=!0:e.flags.reset=!0);c.clean&&(e.flags.factory=!0);A=!c.internal}else e.flags.first_install=!0,A=!c.internal||c.save;a.includes.length||a.matches.length||h||c.internal||e.warnings.push(d.getMessage("This_script_does_not_provide_any__include_information_"));e.flags.sync=!!c.sync;e.flags.internal=c.internal;e.flags.ask=c.ask;e.flags.save=c.save}).then(function(){a.uuid=p;a.system=c.defaultscript;a.evilness=v.getEvilness(a);a.position=v.determineLastPosition()+
1;a.lastModified=g;if(c.force_meta){var d;if(d=c.force_meta.fileURL)a.fileURL=d;if(d=c.force_meta.lastModified)a.lastModified=d}e.flags.factory||e.flags.reset?b&&(a.lastModified=b.lastModified):(c.force_url&&(a.updateURL=null,a.downloadURL=c.force_url),b&&(a.options.override=b.options.override,a.options.comment=b.options.comment,a.options.check_for_updates=b.options.check_for_updates));["includes","excludes","matches","connects"].forEach(function(b){a.options.override["orig_"+b]=a[b]});a.options.override.orig_noframes=
a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(b&&(a.fileURL=b.fileURL,a.position=b.position,b.sync&&(a.sync=b.sync),!e.flags.factory&&!e.flags.reset)){a.enabled=b.enabled;a.options.noframes=b.options.noframes;a.options.run_at=b.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=b.options.compat_forvarin);c.save&&!c.force_url&&(a.downloadURL=b.downloadURL||a.downloadURL);var l=k.determineMetaURL(b),
g=k.determineMetaURL(a),l=l?z.woHash(l):l,g=g?z.woHash(g):g;l==g||h||c.internal||e.warnings.push(d.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[l,g]));c.save||(w.adiff(b.includes,a.includes,"notinfirst").length+w.adiff(b.matches,a.matches,"notinfirst").length+w.adiff(a.excludes,b.excludes,"notinfirst").length&&e.warnings.push(d.getMessage("At_least_one_of_the_include_match_or_exclude_statements_was_changed_")),w.adiff(b.connects||[],a.connects||[],"notinfirst").length&&e.warnings.push(d.getMessage("At_least_one_new_connect_statement_was_added_")))}}).then(function(){if(b&&
!e.flags.factory&&a.version==b.version&&(c.defaultscript||c.noreinstall))return m.Breach()}).then(function(){b?(e.flags.factory||e.flags.reset?(e.flags.reset?(e.heading=d.getMessage("You_are_about_to_reinstall_a_UserScript_"),e.flags.reinstall=!0):(e.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),e.flags.install=!0),c.internal||e.warnings.splice(0,0,d.getMessage("All_script_settings_will_be_reset_"))):e.flags.modification?e.heading=d.getMessage("You_are_about_to_modify_a_UserScript_"):
C.versionCmp(a.version,b.version)==C.versionCmp.eOLDER?(e.heading=d.getMessage("You_are_about_to_downgrade_a_UserScript"),e.flags.downgrade=!0,h||c.internal||e.warnings.splice(0,0,d.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):(e.heading=d.getMessage("You_are_about_to_update_a_UserScript_"),e.flags.update=!0),e.info.push({label:d.getMessage("Installed_Version_"),value:"v"+b.version})):(e.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),h||c.internal||
(e.info.splice(0,0,d.getMessage("Malicious_scripts_can_violate_your_privacy_")),S.getWarningsFor(k.determineSourceURL(a)).forEach(function(a){e.warnings.splice(0,0,a)})),e.flags.install=!0);e.flags.install?e.action=d.getMessage("Install"):e.flags.reinstall?e.action=d.getMessage("Reinstall"):e.flags.modification?e.action=d.getMessage("Modify"):e.flags.downgrade?e.action=d.getMessage("Downgrade"):e.flags.update&&(e.action=d.getMessage("Update"))}).then(function(){c.url&&(a.fileURL=c.url);c.sync&&(a.sync=
c.sync);c.force_options&&w.copy(c.force_options,a.options,(new C.Script).options,!0);c.force_settings&&w.copy(c.force_settings,a,["enabled","position"]);a=v.mergeCludes(a)}).then(function(){var b=!1,c;for(c in a.options)if(-1!=c.search("compat_")&&!0===a.options[c]){b=!0;break}b&&e.info.push({label:d.getMessage("Note"),value:d.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")});var l,g;(l=k.determineOrigin(a))&&(g=l.convert)&&(b=g(a),
b.warning&&e.warnings.push(b.warning),a=b.script)}).then(function(){["requires","resources"].forEach(function(b){a[b]=w.map(a[b],function(b){b.unsafe_url=b.url;b.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;b.url=null;return b})})}).done(function(){l.resolve({script:a,oldscript:b,messages:e,trigger_sync:!!A,short_info:[{label:d.getMessage("Author"),prop:"author"},{label:d.getMessage("Description"),prop:"description"},{label:d.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){l.reject({messages:e})});
return l.promise()},g=function(c){var a=m(),b=c.messages,e=c.script,d=c.trigger_sync,g=function(){var a=k.doModify(e.uuid,e,d)||{};!b.flags.install&&!b.flags.update||b.flags.factory||b.flags.reset||L.tS(e.name,e.fileURL,b.flags.install?"i":"u");b.flags.modification||M.dropAll(e.uuid);(b.flags.first_install||b.flags.factory)&&y.setStorageByUid(e.uuid,{ts:Date.now()});return a},f={lastModified:void 0,installed:!0,renamed:b.flags.renamed};b.warnings.length||b.flags.ask?W.install(c).done(function(b){b.ok&&
g();f.installed=b.ok;f.aborted=b.aborted;a.resolve(f)}).fail(function(b){a.reject(b)}):(g(),a.resolve(f));return a.promise()},h=w.getDebouncer(1E3),k={determineSourceURL:function(c){return c?w.select([c.downloadURL,c.fileURL],function(a){if(!a||"file:"!==z.parse(a).protocol)return a})[0]:null},determineMetaURL:function(c){if(!c)return null;var a,b=v.determineOrigin(c);b&&b.meta_header?a=c.fileURL:!c.fileURL||b&&!b.meta_url||(a=c.fileURL.replace(".user.js",".meta.js"),c.fileURL==a&&(a=c.fileURL.replace(".tamper.js",
".meta.js")),c.fileURL==a&&(a=null));return w.select([c.updateURL,c.downloadURL,a],function(a){if(!a||"file:"!==z.parse(a).protocol)return a})[0]},mergeCludes:function(c){var a,b,e=c.options.override;["includes","excludes","matches"].forEach(function(a){c[a]=e["merge_"+a]&&e["orig_"+a]?e["orig_"+a].slice():[]});if(e.use_includes)for(a=0;a<e.use_includes.length;a++)b=c.excludes.indexOf(e.use_includes[a]),0<=b&&c.excludes.splice(b,1),c.includes.push(e.use_includes[a]);if(e.use_matches)for(a=0;a<e.use_matches.length;a++)b=
c.excludes.indexOf(e.use_matches[a]),0<=b&&c.excludes.splice(b,1),c.matches.push(e.use_matches[a]);if(e.use_excludes)for(a=0;a<e.use_excludes.length;a++)c.excludes.push(e.use_excludes[a]);return c},doSave:function(c){return r(c).then(g)},doRemove:function(c,a){y.removeByUid(c,a);y.setStorageByUid(c,null);M.dropAll(c);return m.Pledge()},doModify:function(c,a,b){void 0===b&&(b=!0);y.setByUid(c,a,b);return b?M.loadResources(c,a.resources).then(function(){return M.loadRequires(c,a.requires)}).then(function(){var b=
[].concat(a.resources).concat(a.requires).map(function(a){return z.sanitize(a.unsafe_url,a.abs_url)});return M.dropAllBut(c,b)}):m.Pledge()},exportToJson:function(c,a){var b=m(),e=v.determineScriptsToRun(null);c&&(e=w.select(e,function(a){return c[a.uuid]}));e=ra(e,!0);a&&!a.storage||e.forEach(function(a){a.storage=y.getStorageByUid(a.uuid)});e={scripts:e};if(!a||a.global_settings)e.global_settings=t.getValue(q.CONSTANTS.STORAGE.CONFIG,{});b.resolve(e);return b.promise()},importFromJson:function(c){if(!c||
!c.scripts||!c.scripts.length)return m.Breach();for(var a={},b=[],e={},d=0,f;f=c.scripts[d];d++)try{var h=m();"new-user-script"!=f.uuid&&(f.storage&&(e[f.uuid]=f.storage),r({uuid:f.uuid,name:f.name,src:f.source,force_settings:{enabled:f.enabled,position:f.position},force_options:f.options,force_meta:{lastModified:f.lastModified},replace:!0,url:f.file_url||f.update_url,ask:!1}).done(function(b){a[w.createUUID()]=b;h.resolve()}).fail(function(a){n.warn("import: Error @ script",f.name,a);h.resolve()}),
b.push(h.promise()))}catch(k){n.warn("import: Error while importing script",f.name,k)}var p=function(){var a=m();m.when(b).always(function(){a.resolve()});return a.promise()}().then(function(){return W.import(a,c.global_settings)}).then(function(b){var c=m(),d=[],l=[];if(b.ok)for(var f=0,h;h=b.import_ids[f];f++)(function(){var b=h;if(a[b]){a[b].messages.warnings=[];var c=g(a[b]).done(function(){var c;(c=a[b].script.uuid)&&e[c]&&(c=y.setStorageByUid(c,{data:e[c].data||{},ts:Date.now()}),l.push(c))});
d.push(c)}})();m.when(d).always(function(){v.reorderScripts();m.when(l).always(function(){c.resolve(b)})});return c.promise()}).then(function(a){return c.global_settings&&a.global_settings?(a=t.setValue(q.CONSTANTS.STORAGE.CONFIG,c.global_settings).then(function(){p.done(function(){window.setTimeout(V.reset,1)});return m.Pledge({global_settings:!0})}),t.setTemporary(!0),a):m.Pledge({})});return p},installFromUrl:function(c,a,b){var e=m(),l=z.parse(c),g={messages:{errors:[d.getMessage("Unable_to_load_script_from_url_0url0",
c)],warnings:[]}};a=a||{};b=b||{};var f=["url",c,JSON.stringify(a)].join("_");if(h.is(f))return n.debug("scriptman: de-bounced installFromUrl",c),m.Breach();h.add(f);if(!l.protocol.match(/(https?|file):/))return n.warn("scriptman: can't install from ",c),m.Breach(g);"file:"!=l.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",c,"-> more info:","http://tampermonkey.net/faq.php#Q204");Z.getScriptFromURL(c).then(function(d){var l=
{url:c,src:d,ask:!0,replace:!0};a&&w.each(a,function(b,c){l[c]=a[c]});e.consume(k.installFromSource(d,l,b))}).fail(function(a){a?("file:"!=l.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||g.messages.warnings.unshift(d.getMessage("Tampermonkey_has_no_file_access_permission_")),g.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),b.silent_fail?e.reject(g):W.installError(g).always(function(a){e.reject(a)})):e.reject()});return e.promise()},installFromSource:function(c,a,b){var e=m(),l={src:c,
ask:!0,replace:!0};a&&w.each(a,function(b,c){l[c]=a[c]});k.doSave(l).done(function(a){e.resolve(a.installed)}).fail(function(a){a?(a.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),b.silent_fail?e.reject(a):W.installError(a).always(function(a){e.reject(a)})):e.reject()});return e.promise()},determineLastPosition:function(){var c=0;y.getUidList().forEach(function(a){var e=y.getByUid(a);e.script&&e.cond?e.script.position&&e.script.position>c&&(c=e.script.position):n.warn("scriptman: inconsistent script entry",
a)});var a=new C.Script;a.position>c&&(c=a.position);return c},convertToRegExp:function(c,a){var b,e;try{a||"/"!=c.substr(0,1)?a?(e=z.getRegExpFromMatch(c),b=new RegExp(e)):(e=z.getRegExpFromInclude(c),b=new RegExp(e,"i")):b=new RegExp(("^"==c.substr(1,1)?"":".*")+c.replace(/^\//g,"").replace(/\/$/g,"")+("$"==c.substr(-2,1)?"":".*"),"i")}catch(d){return n.warn("scriptman: invalid regexp ",c),!1}return b},matchUrl:function(c,a){return""===c.replace(a,"")},regexify:function(c,a){var b={},e={inc:"rinc",
match:"rinc",exc:"rexc"};Object.keys(e).forEach(function(d){var g=c[d]&&c[d].length?c[d].map(function(a){return k.convertToRegExp(a,"match"===d)}).filter(function(a){return!1!==a}):null;if(g||a)b[e[d]]=(b[e[d]]||[]).concat(g||[])});return b},validUrl:function(c,a,b){var e=!1;if(a.rinc){if(a.rinc.every(function(a){return k.matchUrl(c,a)?(n.debug('scriptman: @include "'+a+'" matched'+(b?" ("+b+")":'"')),e=!0,!1):!0}),!e)return e}else e=!0;a.rexc&&a.rexc.every(function(a){return k.matchUrl(c,a)?(n.debug('scriptman: @exclude "'+
a+'" matched'+(b?" ("+b+")":'"')),e=!1):!0});return e},getEvilness:function(c){var a=0;return c.fileURL&&(a=S.getEvilnessOf(c.fileURL))||c.downloadURL&&(a=S.getEvilnessOf(c.downloadURL))||c.updateURL&&(a=S.getEvilnessOf(c.updateURL))?(n.debug("scriptman: found blacklisted script",c),a):0},blackCheckAll:function(){y.getUidList().forEach(function(c){var a=y.getByUid(c);if(a.script&&a.cond){var b=v.getEvilness(a.script);if(b!==a.script.evilness){if(b||void 0!==a.script.evilness)n.debug("scriptman: write blacklist state of ",
a.script.name,b),b&&L.tS(a.script.name,b,"b");a.script.evilness=b;k.doModify(c,a.script,!1)}}})},reorderScripts:function(c,a){var b=k.determineScriptsToRun();if(c)for(var e=0;e<b.length;e++){var d=b[e];d.uuid==c&&(d.position=Number(a)+(d.position<a?.5:-.5))}b=B(b);e=1;for(d=0;d<b.length;d++){var g=b[d];g.position=e++;k.doModify(g.uuid,g,!1)}},getUniqueScriptsForTab:function(c){var a=[];D.get.empty(c.id)?n.debug("bg: WARN: Tabs.get.urls["+c.id+"] is empty!"):w.each(D.get.urls(c.id),function(b,c){if(U.isAllowed(c))for(var d=
v.determineScriptsToRun(c),g=0;g<d.length&&(0===b.frameId||!0!==d[g].options.noframes&&(null!==d[g].options.noframes||!0!==d[g].options.override.orig_noframes));g++){for(var f=!1,h=0;h<a.length;h++)if(a[h].uuid==d[g].uuid){f=!0;break}f||a.push(d[g])}});return a},scriptWillRun:function(c,a){if(a&&c){var b=J.items.regexp.get(c);if(!b){if(!(b=t.getValue(q.CONSTANTS.PREFIX.COND+c,null)))return;b=k.regexify(b,!0);J.items.regexp.set(c,b)}return!!k.validUrl(a,b,c)}},determineScriptsToRun:function(c,a){var b=
[];n.debug("scriptman: determineScriptsToRun @"+c);y.getUidList().forEach(function(e){var d=!0,g=0;c&&(g=Date.now(),d=k.scriptWillRun(e,c),g=Date.now()-g);var f=y.getByUid(e);f.script&&f.cond?(a&&1E3<g&&n.warn("scriptman: checking "+f.script.name+"'s ("+e+") includes and excludes took "+g+"ms!"),d&&b.push(f.script)):n.warn("scriptman: inconsistent script entry",e,f)});return B(b)},isContexter:function(c){return c.options&&("context-menu"===c.options.run_at||null===c.options.run_at&&"context-menu"===
c.options.override.orig_run_at)},determineOrigin:function(c){return k.determineOriginOfUrl(c.fileURL||c.downloadURL||c.updateURL)},determineOriginOfUrl:function(c){if(c){var a=c.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||c.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};
if((a=c.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==a.length)return{id:a[1],token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+a[1],issue_url:"https://greasyfork.org/scripts/"+a[1]+"/feedback"};if((a=c.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+
"/issues"};if((a=c.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==a.length)return{id:a[2],token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]};if((a=c.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&
3==a.length)return a.shift(),{id:a.join("/"),token:"gh",url:"https://github.com/"+a.join("/"),issue_url:"https://github.com/"+a.join("/")+"/issues"};if((a=c.match(/https?:\/\/gitlab\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"gl",url:"https://gitlab.com/"+a.join("/"),issue_url:"https://gitlab.com/"+a.join("/")+"/issues"};if((a=c.match(/https?:\/\/bitbucket\.org\/([^/]+)\/([^/]+)\/(?:raw|downloads)\/.*\.user\.js/))&&3==a.length)return a.shift(),
{id:a.join("/"),token:"bb",url:"https://bitbucket.org/"+a.join("/"),issue_url:"https://bitbucket.org/"+a.join("/")+"/issues"};if((c=c.match(/https?:\/\/userstyles\.org\/styles\/userjs\/([^/]+)\/.*\.user\.js/))&&2==c.length)return c.shift(),{id:c[0],token:"usty",url:"https://userstyles.org/styles/"+c[0],issue_url:"https://forum.userstyles.org/post/discussion?Discussion/StyleID="+c[0],convert:function(a){var c,l,g,f,h,k=[{tag:"includes",re:/(?: \|\| \(new RegExp\("\^)([^$]+)(?:\$"\)\)\.test\(document\.location\.href\))/g,
idx:1,value:function(a){return"/^"+a.replace(/\\\\(.)/g,"\\$1")+"$/"}},{tag:"matches",re:/(?: \|\| \(document\.domain == ")([^\"]+)"(?: \|\| document\.domain\.substring\(document\.domain\.indexOf\("[^\"]+"\) \+ 1\) == "[^\"]+"\))/g,idx:1,value:function(a){return"*."+a}}],r=new RegExp("(?:if \\(false)("+k.map(function(a){return"(?:"+a.re.source+")"}).join("|")+")+","g");0===a.includes.length&&0===a.matches.length&&0===a.excludes.length&&a.options&&a.options.override&&a.options.override.orig_includes&&
0===a.options.override.orig_includes.length&&a.options.override.orig_matches&&0===a.options.override.orig_matches.length&&(g=a.textContent.match(r))&&1===g.length&&(l=g[0])&&(k.forEach(function(c){for(;f=c.re.exec(l);)if(f.length>c.idx){var e=c.value(f[c.idx]);a.options.override["orig_"+c.tag].push(e);a[c.tag].push(e);h=!0}}),h&&(c=d.getMessage("Automatically_added_user_includes_for_compatibility_reasons_")));return{script:a,warning:c}}}}}};return k}(),y=function(){var d=[],r={init:function(){t.addDifferentOriginChangeListener(q.CONSTANTS.PREFIX.STORE,
function(d,f){if(f&&f.hasOwnProperty("value")&&f.origin){var k=d.replace(q.CONSTANTS.PREFIX.STORE,""),c;for(c in f.value.data)f.value.data.hasOwnProperty(c)&&function(){var a=c,b=f.value.data[c];r.notifyStorageListeners({uuid:k},null,function(c){var d={data:{},ts:0};d.data[a]=b;d.ts=f.value.data.ts;var g={storage:d};void 0===d.data[a]&&(g.removed=a);c(g)})}()}})},getUidList:function(){var d=new RegExp("^"+q.CONSTANTS.PREFIX.SCRIPT_UID),f=[];t.listValues().forEach(function(k){-1!=k.search(d)&&f.push(k.replace(d,
""))});return f},getUidsByName:function(d,f){var k=[];r.getUidList().forEach(function(c){var a=r.getMetaByUid(c);!a||a.name!=d||f&&f!=a.namespace||k.push(c)});return k},getUidByName:function(d){return r.getUidsByName(d)[0]},getStorageByUid:function(d){d=t.getValue(q.CONSTANTS.PREFIX.STORE+d,{ts:0,data:{}});"undefined"===typeof d.ts&&(d.ts=0);"undefined"===typeof d.data&&(d.data={});return d},setStorageByUid:function(d,f){return f?t.setValue(q.CONSTANTS.PREFIX.STORE+d,f):t.deleteValue(q.CONSTANTS.PREFIX.STORE+
d)},getMetaByUid:function(d){return t.getValue(q.CONSTANTS.PREFIX.META+d,null)},getByUid:function(d,f){if(!d)return n.error("sb: no UUID set"),{};var k,c=t.getValue(q.CONSTANTS.PREFIX.META+d,null);if(c){var a=function(a){if(a)for(var c=0,d=null;d=a[c];c++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};a(c.requires);a(c.resources);c.uuid=d;c.grant=c.grant||[];c.options.override.use_connects||(c.connects=c.connects||[],c.options.override.merge_connects=!0,c.options.override.use_connects=
[]);void 0===c.options.check_for_updates&&(c.options.check_for_updates=!0);f&&(c=w.copy(c,{}));c.textContent=t.getValue(q.CONSTANTS.PREFIX.SCRIPT+d,c.textContent);c.textContent&&(k=c)}return{script:k,cond:t.getValue(q.CONSTANTS.PREFIX.COND+d,null)}},setByUid:function(d,f,k){var c={};if(!d)return n.error("sb: no UUID set",f),c;if(null===f.textContent||void 0===f.textContent)throw Error("No script code set!");var a=t.getValue(q.CONSTANTS.PREFIX.META+d),b=!a;t.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+
d,f.name);t.setValue(q.CONSTANTS.PREFIX.COND+d,{inc:f.includes,match:f.matches,exc:f.excludes});t.setValue(q.CONSTANTS.PREFIX.SCRIPT+d,f.textContent);var e=w.copy(f,{});e.textContent=null;t.setValue(q.CONSTANTS.PREFIX.META+d,e);k&&(ja.onScriptsChanged(),b?K.scriptAddedCb(f.name,f):K.scriptChangedCb(f.name,f,a));J.items.rundata.removeAll();J.items.regexp.remove(d);return c},removeByUid:function(d,h){void 0===h&&(h=!0);var k=r.getByUid(d);t.deleteValue(q.CONSTANTS.PREFIX.SCRIPT_UID+d);t.deleteValue(q.CONSTANTS.PREFIX.COND+
d);t.deleteValue(q.CONSTANTS.PREFIX.SCRIPT+d);t.deleteValue(q.CONSTANTS.PREFIX.META+d);t.deleteValue(q.CONSTANTS.PREFIX.STORE+d);h&&(ja.onScriptsChanged(),k.script&&k.cond&&(K.scriptRemovedCb(k.script.name,k.script),f.values&&L.tS(k.script.name,null,"r")));J.items.rundata.removeAll();J.items.regexp.remove(d);return{}},addStorageListener:function(f,h,k,c,a){d.push({tabid:f,id:h,uuid:k,time:c,response:a})},removeStorageListeners:function(f,h){void 0===h&&(h=!0);var k=d;d=[];k.forEach(function(c){try{void 0!==
f.tabid&&f.tabid!==c.tabid||void 0!==f.uuid&&f.uuid!==c.uuid||void 0!==f.id&&f.id!==c.id?d.push(c):h&&c.response({})}catch(a){n.debug("sb: listener clear for script",f,"failed! Page reload?!")}})},notifyStorageListeners:function(f,h,k){f=f||{};h=h||{};d.forEach(function(c){try{void 0!==h.uuid&&c.uuid===h.uuid||void 0!==h.tabid&&c.tabid===h.tabid||void 0!==h.id&&c.id===h.id||void 0!==f.tabid&&f.tabid!==c.tabid||void 0!==f.uuid&&f.uuid!==c.uuid||void 0!==f.id&&f.id!==c.id||k&&k(c.response)}catch(a){n.warn("sb: listener notification for script",
f,"failed! Page reload?!")}})}};return r}();scbr=y;var wa=function(){var B={ping:{allow:{insecure:!0},exec:function(a,b,c){c({pong:!0,instanceID:ua,config:{layout:f.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):la()).then(function(b){rea.tabs.create({url:a.url,parent:b},function(a){c({tabId:a.id})})})}},getTab:{allow:{script:!0},exec:function(a,b,c){b.tab&&a.uuid?(P[b.tab.id]||(P[b.tab.id]={}),P[b.tab.id][a.uuid]||(P[b.tab.id][a.uuid]=
{}),c({data:P[b.tab.id][a.uuid]})):(n.warn("bg: unable to process request",b,a),c({data:null}))}},getTabs:{allow:{script:!0},exec:function(a,b,c){if(a.uuid){var d={};Object.keys(P).forEach(function(b){d[b]={};d[b]=P[b][a.uuid]});c({data:d})}else n.warn("bg: unable to process request",b,a),c({data:null})}},setTab:{allow:{script:!0},exec:function(a,b,c){if(b.tab&&a.uuid){P[b.tab.id]||(P[b.tab.id]={});var d={};a.tab&&Object.keys(a.tab).forEach(function(b){d[b]=a.tab[b]});P[b.tab.id][a.uuid]=d}else n.warn("bg: unable to process request",
b,a);c({})}},focusTab:{allow:{script:!0},exec:function(a,b,c){(a=b&&b.tab?b.tab.id:null)?rea.tabs.update(a,{active:!0},function(){c({error:rea.runtime.lastError})}):c({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(a,b,c){var d=b&&b.tab?b.tab.id:null;d?rea.tabs.query({windowType:"normal"},function(a){1>=a.length?(n.warn("bg:","refused to close last tab!"),c({error:"refused to close last tab!"})):rea.tabs.remove(d,function(){c({})})}):c({error:"internal error"})}},setOption:{allow:{extpage:!0},
exec:function(a,b,c){var d="options"==b.extpage||"options"==a.origin;f.setValue(a.name,a.value).always(function(){d?T.create("options.settings").done(function(a){c({items:a,options:f.snapshot})}).fail(function(a){c({error:a,options:f.snapshot})}):c({})})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):la()).then(function(b){var d,f,g,h;if(a.uuid&&(d=y.getByUid(a.uuid))&&d.script&&d.cond){f=v.determineOrigin(d.script);var k;if("hoster"==
a.to&&f)g=f,h=[g.token,g.id].join(":");else if(k=d.script.supportURL||f.issue_url||f.url)g={issue_url:k},h=f?[a.to,f.token,f.id].join(":"):[a.to,g.url].join(":");g&&(L.tS(d.script.name,h,"m"),rea.tabs.create({url:g.abuse_url||g.issue_url,active:!0,parent:b},function(){}))}c({})})}},begEvent:{allow:{extpage:!0},exec:function(a,b,c){if("dialog"==a.action)aa.dialog.shown(a.extra);else if("clicked"==a.action){var d,f;a.extra&&(d=a.extra.amount,f=a.extra.currency);aa.clicked(a.type,d,f)}else if(aa.button[a.action])aa.button[a.action](a.type,
a.extra);else n.warn("bg: Warning: unknown request ",a);c({})}},buttonPress:{allow:{extpage:!0},exec:function(a,b,c){b=function(){c({})};if("reset_simple"==a.name)V.reset(b);else if("reset_factory"==a.name)V.factoryReset(b);else if("reset_sync"==a.name)K.reset().always(b);else if("install_tests"==a.name)(b=fa.framework.prepare(v.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION,b))&&n.error(b);else if("enabled"==a.name)f.setValue(a.name,!f.values[a.name]).always(function(){c({})});else if("installFromUrl"==
a.name)v.installFromUrl(a.data).always(function(){c({})});else if("externals_delete"==a.name)M.cleanElement(a.scriptuid,a.safe_url),T.create("options.scripts").done(function(a){c({items:a,options:f.snapshot})}).fail(function(a){c({error:a,options:f.snapshot})});else if("focus_tab"==a.name)B.focusTab.exec({},{tab:{id:a.tabid}},c);else if("run_script_updates"==a.name)if(a.scriptuid){var d;Z.check(!0,!1,a.scriptuid).done(function(a){d=a}).always(function(){c({scriptuid:a.scriptuid,updatable:d})})}else Z.check(!0,
!0),c({});else n.warn("bg: Warning: unknown button "+a.name),c({})}},loadTree:{allow:{extpage:!0},exec:function(a,b,c){T.create(a.referrer,{complete:a.complete,url:a.url,uuid:a.uuid}).done(function(b){b={items:b,i18n:f.values.i18n,options:f.snapshot,begging:aa.needed()};a.layout&&(b.layout=ha.getLayoutByValue(f.values.layout));c(b)}).fail(function(a){c({error:a,options:f.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,b,c){if(a.uuid){var d="options"==b.extpage||"options"==a.origin,
g=void 0==a.reload||1==a.reload,h=!1,p=y.getByUid(a.uuid,!0);if(p.script&&p.cond){var k=!1,r=new C.Script;Object.keys(r.options).forEach(function(b){void 0!==a[b]&&(p.script.options[b]=a[b],h|=!0===K.SYNCED[b])});Object.keys(r.options.override).forEach(function(b){-1!=b.search("merge_")&&void 0!==a[b]&&(p.script.options.override[b]=a[b],k=!0)});["includes","excludes","matches"].forEach(function(b){void 0!==a[b]&&(k=!0,p.script.options.override["use_"+b]=a[b])});["connects","blockers"].forEach(function(b){void 0!==
a[b]&&(p.script.options.override["use_"+b]=a[b])});k&&(p.script=v.mergeCludes(p.script));a.temp_connects&&ea.setSessionConnects(p.script.uuid,a.temp_connects);void 0!==a.enabled&&(p.script.enabled=a.enabled);h&&(p.script.lastModified=Date.now());v.doModify(p.script.uuid,p.script,h).done(function(){g?(void 0!==a.position&&v.reorderScripts(a.uuid,a.position),d?B.loadTree.exec({referrer:"options.scripts"},b,c):rea.tabs.getSelected(null,function(b){T.create("actions").done(function(a){c({items:a,i18n:f.values.i18n,
options:{enabled:f.values.enabled,layout:f.values.layout}})}).fail(function(){c({i18n:f.values.i18n,options:{enabled:f.values.enabled,layout:f.values.layout}})});a.uuid&&f.values.autoReload&&rea.tabs.sendMessage(b.id,{method:"reload",frameId:0},function(){})})):c({})}).fail(function(){c({})})}else c({})}else c({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(a,b,c){if(a.nid){var l=void 0==a.reload||1==a.reload;O.getUserscriptById(a.nid).then(function(c){if(c)if("installed"==a.actionid){if("false"==
a.value)return O.uninstall(c)}else{if("enabled"==a.actionid)return O.setEnabled(c,a.value);if("imported"==a.actionid&&"true"==a.value){var e=O.getUserscriptSource(c);if(e)return v.doSave({src:e,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==f.values.native_import_post_action)return O.setEnabled(c,!1);if("uninstall"==f.values.native_import_post_action)return O.uninstall(c)}});rea.tabs.sendMessage(b.tab.id,{method:"showMsg",msg:d.getMessage("Please_double_check_the_native_script_import_settings__")},
function(){})}}else l=!1;return m.Pledge()}).always(function(){l?B.loadTree.exec({referrer:"options.scripts"},b,c):c({})})}else c({})}},saveScript:{allow:{extpage:!0},exec:function(a,b,c){var l=void 0===a.reload||!!a.reload,g=function(a){l?T.create("options.scripts").done(function(b){a.items=b;a.options=f.snapshot;c(a)}).fail(function(a){c({error:a,options:f.snapshot})}):c({})};if(a.clean){n.debug("bg: clean userscript "+a.uuid);b=y.getByUid(a.uuid);var h=function(b){T.create("options.scripts").done(function(d){c({cleaned:b.installed,
items:d,options:f.snapshot});b.installed&&y.notifyStorageListeners({uuid:a.uuid},null,function(b){b({storage:y.getStorageByUid(a.uuid)})})}).fail(function(a){c({error:a,options:f.snapshot})})};b.script&&b.cond?v.doSave({name:a.name,uuid:a.uuid,src:b.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){h(a||{installed:!1})}):(n.error(d.getMessage("fatal_error")+" ("+a.uuid+")!!!"),h({installed:!1}))}else if(a.code){var p=c;l&&(p=function(a){v.reorderScripts();g(a)});a.new_script&&
(a.uuid=w.createUUID());v.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!f.values.editor_easySave,lastModTime:a.lastModTime,save:!0}).always(function(a){p(a||{installed:!1})})}else a.auto_save||(v.doRemove(a.uuid),v.reorderScripts()),g({})}},saveExternal:{allow:{extpage:!0},exec:function(a,b,c){M.setElement(a.uuid,a.url,{content:a.code||"",meta:a.mimetype||"text/javascript"},!0);T.create("options.scripts").done(function(a){c({success:!0,items:a,options:f.snapshot})}).fail(function(a){c({error:a,
options:f.snapshot})})}},saveStorageKey:{allow:{extpage:!0},exec:function(a,b,c){h.saveStorageKey.exec(null,a,b,c)}},exportToJson:{allow:{extpage:!0},exec:function(a,b,c){v.exportToJson(a.ids,a.options).done(function(a){c({json:a})}).fail(function(){c({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,b,c){var l=void 0===a.reload||!!a.reload;v.importFromJson(a.json).fail(function(a){c({error:a||d.getMessage("An_error_occured_during_import_")})}).done(function(a){var b={reload:a.global_settings};
l&&!b.reload?T.create("options.scripts").done(function(a){b.items=a;b.options=f.snapshot;c(b)}).fail(function(a){c({error:a,options:f.snapshot})}):c(b)})}},download:{allow:{extpage:!0},exec:function(a,b,c){h.download.exec(null,a,b,function(a){(a.error||a.load)&&c(a)})}},askCom:{allow:{extpage:!0},exec:function(a,b,c){W.onMessage(a.data).always(function(b){b.i18n=f.values.i18n;b.options=f.snapshot;b.ext={version:rea.extension.manifest.version};a.data.layout&&(b.layout=ha.getLayoutByValue(f.values.layout));
c(b)})}},installScript:{allow:{extpage:!0},exec:function(a,b,c){if(b.tab){var f={};v.installFromUrl(a.url,{},{silent_fail:!0}).done(function(a){f={data:null,found:!0,installed:a}}).fail(function(a){f.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:d.getMessage("Unable_to_parse_this_")}).always(function(){c(f)})}else n.warn("bg: Error: unable to install script due to empty tabID!")}},execMenuCmd:{allow:{extpage:!0},exec:function(a,b,c){(a=ba.getById(a.id))?a.response({run:!0,menuId:a.id}):
n.warn("bg: Error: unable to find MC id "+a.id);c({})}},unLoad:{allow:{script:!0},exec:function(a,b){a.topframe||a.id&&b.frameId&&D.events.unload(b.tab.id,b.frameId,a.id);return!1}},prepare:{allow:{script:!0},exec:function(a,b,c){if(b.tab){var d=void 0!==b.frameId?b.frameId:a.topframe?0:null,f=z.woHash(a.url);a.cleanup?(D.events.clean(b.tab.id,d,f),Q.setIcon(b.tab.id),Q.setBadge(b.tab.id),c({})):D.events.run(b.tab.id,d,a.id,f,function(d){d=d?ca.answer(d,a.url):{fast:!0};c(d);Q.setIcon(b.tab.id);Q.setBadge(b.tab.id)})}else c({})}},
notification:{allow:{script:!0,extpage:!0},exec:function(a,b,c){var d=a.image?a.image:rea.extension.getURL("images/icon128.png");(function(){var c=m();a.highlight&&b.tab?R.highlight(b.tab.id,c.resolve):c.resolve();return c.promise()})().then(function(){var b=m();a.text?R.show(a.title,a.text,d,a.timeout,b.resolve):b.resolve();return b.promise()}).always(function(a){c({clicked:a&&a.clicked})})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(a,b,c){c({scripts:v.determineScriptsToRun(a.url).map(function(a){return a.uuid})})}},
syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(a,b,c){(function(){var a=m();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(b){return b.hint(a.code,{maxerr:999},{})}).always(function(a){c({errors:a})})}},externalMessage:{allow:{insecure:!0},exec:function(a,b,d){a=a.request;var g;if("off"!=f.values.external_connect&&(g=b.url)&&U.isAllowed(g)){for(var h,k,p,r=Object.keys(c.externally_connectable),m=0;m<r.length;m++)if(h=r[m],b=c.externally_connectable[h],
(k=v.regexify({match:[h]}))&&v.validUrl(g,k)&&(-1!=b.indexOf("*")||-1!=b.indexOf(a.method))){p=!0;break}if(p)if("getVersion"==a.method)d({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=f.values.external_connect)n.warn("mh: calling external method "+a.method+" is not permitted to "+g+" by the user");else if("isInstalled"==a.method){var B,q,t,w;g=!1;k=a.script.name;(q=y.getUidsByName(k,a.script.namespace)[0])&&(B=y.getByUid(q))&&B.script&&(g=!0,w=B.script.enabled,t=
B.script.version);d({name:k,installed:g,enabled:w,version:t})}else n.warn("mh: unknown external method "+a.method);else n.warn("mh: calling external method "+a.method+" is not permitted to "+g)}}},api:{allow:{script:!0},exec:function(a,b,c){L.tA(a.name,a.type);c()}}},r=function(a){var b=rea.runtime.id,b=!q.REQUESTS.HAS_SENDER_ID&&a.tab||a.id===b,c=null,d=q.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",f=q.REQUESTS.GET_INTERNAL_PAGE_REGEXP();a=a.url?a.url:a.tab?a.tab.url:null;if(d=b&&(a?0==a.search(d):!0))a?
(f=a.match(f))&&2==f.length&&(c=f[1]):c="*";return{id_valid:b,url:a,page:c,extpage:d}},g=function(a,b,c){if(!F.late)return F.registerLateCallback(function(){g(a,b,c)}),!0;var d=B[a.method];if(!d)return n.warn("mh: unknown method "+a.method),!1;if(!d.allow||!d.exec)return n.warn("mh: invalid implementation of "+a.method),!1;var f=r(b),h=f.extpage,p=f.page,f=f.id_valid;h?b.extpage=p:delete a.origin;var k="options"==p,m=!0;if("background"==p||d.allow.insecure||d.allow.extpage&&h||d.allow.options&&k||
d.allow.script&&f&&!h){if(d=d.exec(a,b,function(a){m=!1;c(a)}),!1!==m&&!1!==d)return!0}else return!1===a.topframe&&(h||k)||n.warn("mh: this context doesn't have the permission to call \""+a.method+'"'),!1},h={xhr:{allow:{script:!0},exec:function(a,b,c,d){var g=!1,h=function(){a.disconnect()};b.details.convertBinary=!0;b.details.partialSize=b.details.partialSize||q.XMLHTTPREQUEST.PARTIAL_SIZE;var p={};Object.keys(b.callbacks).forEach(function(a){var c="ondone"===a;if(b.callbacks[a]||c||"onload"===
a)p[a]=function(b){b={data:b.response,exception:b.exception};b[a]=!0;d(b);c&&h()}});p.ondone||(p.ondone=h);var k=function(a){var b=m(),c=[];rea.cookies.getAll({url:a},function(a){c=c.concat(a);b.resolve(c)});return b.promise()},r;b.details.url=z.sanitize(b.details.url,b.url||c.url||null)||b.details.url;q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=f.values.webrequest_modHeaders&&(b.details.headers=b.details.headers||{},b.details.headers.internal=b.uuid,q.REQUESTS.SENDS_ORIGIN&&-1==Object.keys(b.details.headers).map(function(a){return a.toLowerCase()}).indexOf("origin")&&
(b.details.headers.origin=null));(function(){return b.details.cookie&&b.details.url?k(b.details.url).then(function(a){a=a.map(function(a){return a.name+"="+encodeURIComponent(a.value)}).concat([b.details.cookie]).join(";");delete b.details.cookie;b.details.headers=b.details.headers||{};b.details.headers.cookie=a}):m.Pledge()})().then(function(){if(!g){var a;if(b.details.url&&(a=z.parse(b.details.url).protocol)&&-1!=["file:",q.REQUESTS.INTERNAL_PAGE_PROTOCOL].indexOf(a)){var d=function(a){var c='Refused to connect to "'+
b.details.url+'": '+a,d=ma.makeErrorResponse(c);["onerror","ondone"].forEach(function(a){if(p[a])p[a]({response:d,exception:c})})};if("file:"==a){var l,h;q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&("all"==f.values.script_file_access?l=!0:"externals"==f.values.script_file_access&&(h=y.getByUid(b.uuid))&&h.script&&h.cond&&-1!=[].concat(h.script.resources).concat(h.script.requires).map(function(a){return z.sanitize(a.unsafe_url,a.abs_url)}).indexOf(b.details.url)&&(l=!0));if(!l)return d("Access to this local file is forbidden!")}rea.file.get(b.details.url,
function(a){var b={response_data:I.arrbuf2str(a),readyState:4,responseHeaders:"",status:0,statusText:""};["onload","ondone"].forEach(function(a){if(p[a])p[a]({response:b})})},d)}else r=ea.exec(b.details,b.uuid,c||{},p)}});return function(){g=!0;r&&r.abort()}}},download:{allow:{script:!0},exec:function(a,b,c,d){b=b.details;b.internal=null===a;H.start(b,{onload:function(a){d({load:!0,data:a})},onprogress:function(a){d({progress:!0,data:a})},onerror:function(a){d({error:!0,data:a})},ontimeout:function(a){d({timeout:!0,
data:a})},ondone:function(){a&&a.disconnect();a=null}})}},webRequest:{allow:{script:!0},exec:function(a,b,c,d){a=c.tab.id;c=c.frameId;(void 0!==a&&void 0!==c||!b.uuid)&&da.scripts.set(a,c,b.uuid,b.rules,function(a){d(a)})}},addStorageListener:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return y.addStorageListener(c.tab.id,b.id,b.uuid,Date.now(),d),function(){y.removeStorageListeners({uuid:b.uuid,id:b.id},!1)};d({error:!0})}},saveStorageKey:{allow:{script:!0},exec:function(a,b,c,d){c.tab?b.uuid&&
(a=y.getStorageByUid(b.uuid),a.data[b.key]=b.value,a.ts=b.ts,y.setStorageByUid(b.uuid,a),y.notifyStorageListeners({uuid:b.uuid},{id:b.id},function(a){var c={data:{},ts:0};c.data[b.key]=b.value;c.ts=b.ts;var d={storage:c};void 0===c.data[b.key]&&(d.removed=b.key);a(d)})):n.warn("storage: unable to save storage due to empty tabID!");d({})}},openInTab:{allow:{script:!0},exec:function(a,b,d,f){a=["active"];var g={url:b.details.url};if(b=b.details.options){for(var h=0;h<a.length;h++)void 0!==b[a[h]]&&
(g[a[h]]=b[a[h]]);b.insert&&(g.index=d.tab.index+1);b.setParent&&(g.parent=d.tab)}rea.tabs.create(g,function(a){c.tabId=a.id;X[a.id]={onClose:function(){f({close:!0})}};f({success:!0,tabId:a.id})});return function(){c.disconnected=!0;c.tabId&&delete X[c.tabId]}}},nameTab:{allow:{script:!0},exec:function(a,b,d,f){if(c.tabId){var g=3,h=function(){D.listeners.once.whenReady(c.tabId,function(){rea.tabs.sendMessage(c.tabId,{method:"setForeignAttr",attr:"name",value:b.name},function(a){a?f({name:b.name}):
0<g--?h():n.warn("foreignAttr: error setting attr")})})};h()}}},closeTab:{allow:{script:!0},exec:function(a,b,d,f){c.tabId&&X[c.tabId]&&rea.tabs.remove(c.tabId);f({});window.setTimeout(function(){try{c.disconnected||a.disconnect()}catch(b){}c.disconnected=!0},1E3)}},registerMenuCommand:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return ba.add(c.tab.id,b.name,b.accessKey,b.menuId,d),za(),function(){ba.clearById(b.menuId);za()};n.warn("Unable to register menu cmd due to empty tabID!");a.disconnect()}},
tabWatch:{allow:{extpage:!0},exec:function(a,b,c,d){var f=sa.openAndWatch({url:b.url,index:(c.tab.index||0)+1,parent:c.tab},function(b){b?d({tab:b}):(g(),a.disconnect())}),g=function(){f.cancel()};return g}}},k=function(){var a=function(a,c){var d=a.sender,f=h[c.method];if(!f)return n.warn("mh: unknown method "+c.method),!1;if(!f.allow||!f.exec)return n.warn("mh: invalid implementation of "+c.method),!1;var g=r(d),p=g.extpage,k=g.page,m="options"==k,g=g.id_valid&&!p;if("background"==k||f.allow.insecure||
f.allow.extpage&&p||f.allow.options&&m||f.allow.script&&g)(d=f.exec(a,c,d,function(c){try{a.postMessage(c)}catch(d){n.debug("bg: Error sending port ("+a.name+") message",c)}}))&&a.onDisconnect.addListener(d);else return!1===c.topframe&&(p||m)||n.warn("mh: this context doesn't have the permission to call \""+c.method+'"'),!1};return function(b){if(F.late){var c={};b.onMessage.addListener(function(d){a.apply(c,[b,d])})}else F.registerLateCallback(function(){k(b)})}}(),c={init:function(){c.externally_connectable_reg=
v.regexify({match:Object.keys(c.externally_connectable)});rea.extension.onMessage.addListener(g);rea.extension.onConnect.addListener(k);rea.extension.onConnectExternal.addListener(function(a){a.disconnect()})},externally_connectable:{"*://tampermonkey.net/*":["getVersion"],"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return c}(),ba=function(){var d=[];return{add:function(f,g,h,k,c){d.push({tabId:f,name:g,accessKey:h,id:k,response:c})},list:function(){return d},listByTabId:function(f){var g=
{};return d.filter(function(d){return d.tabId==f&&!g[d.name]&&(g[d.name]=!0)})},clearByTabId:function(f){d=d.filter(function(d){return d.tabId!=f})},getByTabId:function(f){return d.filter(function(d){return d.tabId==f})[0]},clearById:function(f){d=d.filter(function(d){return d.id!=f})},getById:function(f){return d.filter(function(d){return d.id==f})[0]}}}(),Ea=function(){return{create:function(){var m,r,g,h,k,c,a,b,e,l,n,u,p,A;l=null;m={name:d.getMessage("General"),sub_menu_item:!0,items:[]};m.items.push({name:d.getMessage("Config_Mode"),
id:"configMode",level:0,option:!0,select:[{name:d.getMessage("Novice"),value:0},{name:d.getMessage("Beginner"),value:50},{name:d.getMessage("Advanced"),value:100}],value:f.values.configMode,desc:d.getMessage("Changes_the_number_of_visible_config_options")});m.items.push({name:d.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:d.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(d.supported),value:f.values.i18n,validation:{image:"info",opacity:.9,
msg:d.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),url:"http://tampermonkey.net/faq.php#Q500"}});m.items.push({name:d.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:f.values.autoReload,desc:d.getMessage("Auto_reload_on_script_enabled_desc")});m.items.push({name:d.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:!!f.values.statistics_enabled,validation:{image:"info",
opacity:.9,msg:d.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),url:"http://tampermonkey.net/privacy.php#extension"}});m.items.push({name:d.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:f.values.debug,desc:""});m.items.push({name:d.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:f.values.showFixedSrc,desc:""});m.items.push({name:d.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,
select:[{name:d.getMessage("Debug"),value:60},{name:d.getMessage("Warning"),value:30},{name:d.getMessage("Error"),value:0}],value:f.values.logLevel,desc:""});q.OPTIONS.NATIVE_SCRIPT_IMPORT&&(r={name:d.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},l={},f.values.native_import&&(l=!0===q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:d.getMessage("TM_has_access_to_file_URIs")}:{image:"critical",msg:d.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),
url:"http://tampermonkey.net/faq.php#Q204"}),r.items.push({name:d.getMessage("Enable_Native_Script_Import"),id:"native_import",level:0,option:!0,checkbox:!0,enabled:f.values.native_import,validation:l}),r.items.push({name:d.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:d.getMessage("None"),value:"none"},{name:d.getMessage("Disable_Extension"),value:"disable"},{name:d.getMessage("Uninstall_Extension"),value:"uninstall"}],value:f.values.native_import_post_action,
desc:d.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),l={},f.values.native_import&&(l=O.isPathValid()?{image:"button_ok",msg:d.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:d.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"}),r.items.push({name:d.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,
width:2,value:f.values.native_import_path,validation:l}));u={name:d.getMessage("TESLA"),sub_menu_item:!0,level:50,need_save:!0,items:[]};u.items.push({name:d.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:f.values.sync_enabled,desc:d.getMessage("Tampermonkey_External_Script_List_Access")});g=function(){var a=[],b={reset_sync:!0};rea.storage.sync.supported&&a.push({name:d.getMessage("Browser_Sync"),value:G.types.eCHROMESYNC,enable:b});a.push({name:"Google Drive",
value:G.types.eGDRIVE,enable:b});return a}();u.items.push({name:d.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:g,value:f.values.sync_type});u.items.push({name:d.getMessage("Sync_Reset"),id:"reset_sync",enabledBy:"sync_type",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_remote_data_from_sync_Ok_")});c={name:d.getMessage("Appearance"),sub_menu_item:!0,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};c.items.push({name:d.getMessage("Layout"),
id:"layout",level:0,option:!0,select:ha.getLayouts(),value:f.values.layout,desc:""});c.items.push({name:d.getMessage("User_CSS"),id:"layout_user_css",level:100,option:!0,input:!0,value:f.values.layout_user_css,desc:d.getMessage("You_can_add_your_custom_CSS_rules_here_")});l={};"off"==f.values.notification_showUpdate&&(l={image:"critical",msg:d.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});c.items.push({name:d.getMessage("Update_Notification"),id:"notification_showUpdate",
level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Show_notification"),value:"notification"},{name:d.getMessage("Open_changelog"),value:"changelog"}],value:f.values.notification_showUpdate,validation:l});c.items.push({name:d.getMessage("Favicon_Service"),id:"favicon_service",level:50,option:!0,select:[{name:d.getMessage("Google"),value:"google"},{name:d.getMessage("DuckDuckGo"),value:"duckduckgo"},{name:d.getMessage("Native"),value:"native",warning:d.getMessage("Warning_unsafe_site_warnings_might_appear_")}],
value:f.values.favicon_service});a={name:d.getMessage("Action_Menu"),sub_menu_item:!0,items:[],level:50};a.items.push({name:d.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:f.values.action_menu_scripts_hide_disabled,desc:""});a.items.push({name:d.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:d.getMessage("1"),value:"1"},{name:d.getMessage("2"),value:"2"},{name:d.getMessage("3"),value:"3"}],value:f.values.action_menu_columns});
a.items.push({name:d.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:d.getMessage("Position_"),value:"position"},{name:d.getMessage("Name"),value:"name"},{name:d.getMessage("Enabled"),value:"enabled"}],value:f.values.action_menu_scripts_sort});a.items.push({name:d.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Running_scripts"),value:"running"},{name:d.getMessage("Unique_running_scripts"),
value:"running_unique"},{name:d.getMessage("Disabled_scripts"),value:"disabled"}],value:f.values.appearance_badges});(q.RUNTIME.CHROME||q.RUNTIME.FIREFOX)&&a.items.push({name:d.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:f.values.appearance_badge_color});g={name:d.getMessage("Editor"),sub_menu_item:!0,level:20,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};g.items.push({name:d.getMessage("Enable_Editor"),id:"editor_enabled",level:100,
option:!0,checkbox:!0,enabled:f.values.editor_enabled,desc:""});g.items.push({name:d.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:ha.getEditorThemes(),value:f.values.editor_theme});g.items.push({name:d.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:f.values.editor_fontSize});
g.items.push({name:d.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:d.getMessage("Windows"),value:"windows"},{name:d.getMessage("Sublime"),value:"sublime"},{name:d.getMessage("Emacs"),value:"emacs"},{name:d.getMessage("Vim"),value:"vim"}],value:f.values.editor_keyMap});g.items.push({name:d.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:d.getMessage("1"),value:1},{name:d.getMessage("2"),value:2},{name:d.getMessage("3"),value:3},
{name:d.getMessage("4"),value:4},{name:d.getMessage("5"),value:5},{name:d.getMessage("6"),value:6},{name:d.getMessage("7"),value:7},{name:d.getMessage("8"),value:8},{name:d.getMessage("9"),value:9},{name:d.getMessage("10"),value:10},{name:d.getMessage("11"),value:11}],value:f.values.editor_indentUnit,desc:""});g.items.push({name:d.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:d.getMessage("Tabs"),value:"tabs"},{name:d.getMessage("Spaces"),value:"spaces"}],value:f.values.editor_indentWithTabs,
desc:""});g.items.push({name:d.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:d.getMessage("Classic"),value:"classic"},{name:d.getMessage("Smart"),value:"smart"},{name:d.getMessage("Indent"),value:"indent"}],value:f.values.editor_tabMode,desc:""});g.items.push({name:d.getMessage("Line_break"),id:"editor_lineWrapping",level:50,option:!0,checkbox:!0,enabled:f.values.editor_lineWrapping,desc:""});g.items.push({name:d.getMessage("Reindent_on_typing"),id:"editor_electricChars",
level:50,option:!0,checkbox:!0,enabled:f.values.editor_electricChars,desc:""});g.items.push({name:d.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:f.values.editor_autoSave,desc:""});g.items.push({name:d.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:f.values.editor_easySave,desc:""});g.items.push({name:d.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,
enabled:f.values.editor_highlightTrailingWhitespace,desc:""});g.items.push({name:d.getMessage("Trim_trailing_whitespace_from_modified_lines"),id:"editor_trimTrailingSpacesFromModifiedLines",level:50,option:!0,checkbox:!0,enabled:f.values.editor_trimTrailingSpacesFromModifiedLines,desc:""});g.items.push({name:d.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:f.values.editor_autoLint,desc:d.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});
g.items.push({name:d.getMessage("Auto_syntax_check_max_length"),id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:f.values.editor_autoLintMaxLen,desc:d.getMessage("Check_only_scripts_up_to_this_size_automatically_")});k={name:d.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};k.items.push({name:d.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:f.values.scriptUpdateCheckDisabled,desc:""});k.items.push({name:d.getMessage("Dont_ask_me_for_simple_script_updates"),
id:"notification_silentScriptUpdate",level:80,option:!0,checkbox:!0,enabled:f.values.notification_silentScriptUpdate,desc:""});k.items.push({name:d.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("Every_6_Hours"),value:216E5},{name:d.getMessage("Every_12_Hour"),value:432E5},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5}],value:f.values.scriptUpdateCheckPeriod,desc:""});
k.items.push({name:d.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("15_Seconds"),value:15E3},{name:d.getMessage("30_Seconds"),value:3E4},{name:d.getMessage("1_Minute"),value:6E4},{name:d.getMessage("5_Minutes"),value:3E5},{name:d.getMessage("1_Hour"),value:36E5}],value:f.values.scriptUpdateHideNotificationAfter,desc:""});h={name:d.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};
h.items.push({name:d.getMessage("Update_interval"),id:"external_update_interval",level:0,option:!0,select:[{name:d.getMessage("Always"),value:1},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5},{name:d.getMessage("Every_Month"),value:2592E6},{name:d.getMessage("Never"),value:0}],value:f.values.external_update_interval,desc:""});b={name:d.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};q.OPTIONS.HAS_CSP&&(b.items.push({name:d.getMessage("Add_TM_to_CSP"),
id:"webrequest_fixCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:f.values.webrequest_fixCSP,desc:d.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),b.items.push({name:d.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("No"),
value:"no"}],value:f.values.webrequest_modHeaders,warning:d.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),desc:""}));q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS&&b.items.push({name:d.getMessage("Script_local_files_access"),id:"script_file_access",level:80,option:!0,select:[{name:d.getMessage("All_local_files"),value:"all"},{name:d.getMessage("require_and_resource"),value:"externals"},{name:d.getMessage("Disabled"),value:"off"}],value:f.values.script_file_access});
b.items.push({name:d.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Tampermonkey_and_script_version"),value:"all"},{name:d.getMessage("Tampermonkey_version"),value:"version"},{name:d.getMessage("Disabled"),value:"off"}],value:f.values.external_connect,desc:d.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});
b.items.push({name:d.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:d.getMessage("Disabled"),value:"ignore"},{name:d.getMessage("Validate_if_supported"),value:"supported"},{name:d.getMessage("Validate_if_given"),value:"given"},{name:d.getMessage("Enforce"),value:"enforce"}],value:f.values.require_sri_mode,desc:d.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});b.items.push({name:d.getMessage("connect_mode"),id:"connect_mode",
level:50,option:!0,select:(80<=f.values.configMode||-1!=["off","casual"].indexOf(f.values.connect_mode)?[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Casual"),value:"casual"}]:[]).concat([{name:d.getMessage("Ask_if_unknown"),value:"ask"},{name:d.getMessage("Strict"),value:"strict"},{name:d.getMessage("Always_ask"),value:"paranoid"}]),value:f.values.connect_mode,desc:""});q.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(l="temporary"==f.values.incognito_mode?{}:{image:"critical",
msg:"Permanent mode is still a BETA feature!"},b.items.push({name:d.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:d.getMessage("Temporary"),value:"temporary"},{name:d.getMessage("Permanent"),value:"permanent"}],value:f.values.incognito_mode,validation:l}));b.items.push({name:d.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Blacklist"),value:"black"},{name:d.getMessage("Whitelist"),
value:"white"},{name:d.getMessage("Both"),value:"black+white"}],value:f.values.page_filter_mode,desc:""});b.items.push({name:d.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:f.values.page_whitelist,desc:""});b.items.push({name:d.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:f.values.forbiddenPages,desc:""});e={name:d.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};e.items.push({name:d.getMessage("Script_Blacklist_Source"),
id:"script_blacklist_type",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Server_And_Manual"),value:"server"},{name:d.getMessage("Only_Manual"),value:"only_manual"}],value:f.values.script_blacklist_type});e.items.push({name:d.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:d.getMessage("severity_1"),value:1},{name:d.getMessage("severity_2"),value:2},{name:d.getMessage("severity_3"),value:3},{name:d.getMessage("severity_4"),
value:4},{name:d.getMessage("severity_5"),value:5},{name:d.getMessage("severity_6"),value:6},{name:d.getMessage("severity_7"),value:7},{name:d.getMessage("severity_8"),value:8},{name:d.getMessage("severity_9"),value:9},{name:d.getMessage("severity_10"),value:10}],value:f.values.script_blacklist_severity});e.items.push({name:d.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:f.values.require_blacklist,desc:""});if(q.OPTIONS.CAN_DOWNLOAD){var t=
!1;l={};w.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){t|=H.is_whitelisted(a)});t&&(l={image:"critical",msg:d.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});A={name:d.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};A.items.push({name:d.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:w.select([{name:d.getMessage("Default"),
value:H.staticVars.DEFAULT},{name:d.getMessage("Disabled"),value:H.staticVars.OFF},{name:d.getMessage("Native"),value:H.staticVars.NATIVE},{name:d.getMessage("Browser_API"),value:rea.downloads.supported?H.staticVars.CHROME:null}],function(a){return a.value}),value:f.values.downloads_mode,desc:d.getMessage("The_Browser_API_mode_requires_a_special_permission_")});A.items.push({name:d.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:f.values.downloads_extension_whitelist,
desc:d.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),validation:l})}n={name:d.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};q.RUNTIME.FAST_EXEC_SUPPORT&&(l="fast"==f.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},n.items.push({name:d.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),
value:"default"},{name:d.getMessage("Instant"),value:"instant"},{name:d.getMessage("Normal"),value:"normal"}],value:f.values.runtime_inject_mode,validation:l}));n.items.push({name:d.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"byscript"},{name:d.getMessage("Always"),value:"on"},{name:d.getMessage("Disabled"),value:"off"}],value:f.values.runtime_strict_mode});rea.webRequest.filterResponseData&&q.OPTIONS.HAS_CSP&&n.items.push({name:"Add Tampermonkey to the sites content CSP",
id:"webrequest_fixContentCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:f.values.webrequest_fixContentCSP,warning:"Warning: enabling this option is may break pages!"});l={name:d.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};l.items.push({name:d.getMessage("Script_URL_detection"),id:"scriptUrlDetection",level:80,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Disabled"),value:"manual"}],
value:f.values.scriptUrlDetection});l.items.push({name:d.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:f.values.script_templates});p={name:d.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};p.items.push({name:d.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_restart_Tampermonkey_Ok_")});p.items.push({name:d.getMessage("Factory_Reset"),id:"reset_factory",
level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});fa&&p.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[m,c,a,k,h,void 0,u,r,void 0,g,b,e,A,l,n,p].filter(function(a){return!!a})}}}(),T=function(){return{create:function(B,r){B=B||"";r=r||{};var g=function(c){return m.onebyone(c).fail(function(){n.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},
h=function(c,a){for(var b=c.replace(/\.$/,"").split("."),d=k;b.length;){var f=b.shift();if(d[f]){if("function"===typeof d[f])return function(){return d[f](r,!a)};d=d[f];b.length||b.unshift("root")}else return n.warn("tree: unable to find",c,r),function(){return m.Pledge([])}}n.warn("tree: unable to find",c,r);return function(){return m.Pledge([])}},k={actions:{root:function(){var c=m();rea.tabs.getSelected(null,function(a){r.tab=a;a=g([h("actions.general"),h("actions.scripts"),h("actions.commands")]);
c.consume(a)});return c.promise()},general:function(){var c=r.tab,a=c?c.url:null,b=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",c=[],e={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};e.items.push({name:d.getMessage("Enabled"),display:f.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});c.push(e);"manual"==f.values.scriptUrlDetection&&oa.isScriptUrl(a)&&e.items.push({name:d.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:a,
button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:d.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+I.Base64.encode(b),"nav=dashboard"].join("&"),newtab:!0});b="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"about",urls:[{name:" "+d.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+b,newtab:!0},{name:" "+d.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+
b,newtab:!0}]});c.push(a);return m.Pledge(c)},scripts:function(c){var a=r.tab,b=a?a.url:null,e=[],g=b?z.parse(b):null,g=g&&-1!=["http:","https:","file:"].indexOf(g.protocol)?z.woHash(g):"",h,k={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},a=v.getUniqueScriptsForTab(a),p=ca.getContexters(0,null),a=ra([].concat(a).concat(p)),n;"position"!=f.values.action_menu_scripts_sort&&("name"==f.values.action_menu_scripts_sort?n=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>
b.name.toLowerCase()?1:0}:"enabled"==f.values.action_menu_scripts_sort&&(n=function(a,b){return b.enabled-a.enabled}));f.values.action_menu_scripts_hide_disabled&&(a=a.filter(function(a){return a.enabled}));n&&a.sort(n);!f.values.action_menu_scripts_hide_disabled&&2<Math.min(f.values.action_menu_columns,(c?c.available_columns:null)||99)?(h={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},a.forEach(function(a){(a.enabled?k:h).items.push(a)}),e.push(k),h.items.length&&e.push(h)):(h=k,k.items=
k.items.concat(a),e.push(k));f.values.enabled&&!a.length&&b&&(U.isAllowed(b)?k.items.push({name:d.getMessage("No_script_is_running"),image:"no_script"}):k.items.push({name:d.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));c=d.getLocale();f.values.enabled&&("3"==f.values.action_menu_columns||100>f.values.configMode||!a.length)&&(a.length?(b={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},e.push(b)):b=k,b.items.push({name:d.getMessage("Get_new_scripts___"),
image:"script_search",url:"http://tampermonkey.net/scripts.php"+(c?"?locale="+c:""),newtab:!0}),b.items.push({name:d.getMessage("Add_new_script___"),image:"script_add",url:rea.extension.getURL("options.html")+"#url="+I.Base64.encode(g)+"&nav=new-user-script",newtab:!0}));return m.Pledge(e)},commands:function(){var c=r.tab,a=[],b=d.getLocale(),e={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},g=c.id,c=[],g=null==g||void 0==g?ba.list():ba.listByTabId(g),h;for(h in g)if(g.hasOwnProperty(h)){var k=
g[h];c.push({name:k.name,id:k.id,accessKey:k.accessKey,image:"menu_cmd",menucmd:!0})}c.length&&(e.items=c);e.items.push({name:d.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});80<=f.values.configMode&&e.items.push({name:d.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});e.items.push({name:d.getMessage("Please_consider_a_contribution"),image:"contrib",url:"http://tampermonkey.net/contrib.php?src=a"+(b?"&locale="+b:""),
newtab:!0});a.push(e);return m.Pledge(a)}},options:{root:function(){return g([h("options.general"),h("options.verification"),h("options.scripts"),h("options.settings")])},general:function(){var c,a=[];a.push({name:"Version",id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==f.values.incognito_mode?a.push({globalhint:!0,image:"critical",value:d.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")}):(c=va.updateAvailable())&&
a.push({globalhint:!0,image:"info",class:"information",value:d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,c)});return m.Pledge(a)},verification:function(){var c=[];ga.getWarnings().forEach(function(a){c.push({globalhint:!0,image:"critical",value:a.text,description:a.description,info_url:a.url})});return m.Pledge(c)},scripts:{root:function(c,a){var b=m(),e={name:d.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,
id:"dashboard"};(function(){if(c.complete||!a)return g(w.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return h(a)}));e.referrer="options.scripts";e.partial=!0;return g([h("options.scripts.new")])})().done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()},"new":function(){var c=[];c.push({name:d.getMessage("New_userscript"),id:null,image:"script_add",icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",
position:-1,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return m.Pledge(c)},natives:function(){var c=[],a=m();O.getAllUserscripts().always(function(b){b=b||[];b.forEach(function(a){c.push({name:a.name,uuid:a.id,icon:a.icon,code:null,position:0,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(c)});return a.promise()},userscripts:{root:function(c,a){var b=c.complete||!a?null:"options.scripts.userscripts",b=ra(v.determineScriptsToRun(null),
!0,b),e=b.length,f=d.getLocale();b.push({name:d.getMessage("No_script_is_installed"),image:"info",visible:!e});b.push({name:d.getMessage("Get_some_scripts___"),image:"edit_add",url:"http://tampermonkey.net/scripts.php"+(f?"?locale="+f:""),newtab:!0,visible:!e});return m.Pledge(b)},source:function(c){if(!c.uuid)return m.Pledge([]);c=y.getByUid(c.uuid);if(c.script&&c.cond)return c=f.values.showFixedSrc?na.mkCompat(c.script.textContent,c.script,"off"!=f.values.runtime_strict_mode):c.script.textContent,
m.Pledge([c]);n.warn("tree: unable to process ",c);return m.Breach()},storage:function(c){return c.uuid?m.Pledge([y.getStorageByUid(c.uuid).data]):m.Pledge([])},external:function(c){if(!c.uuid)return m.Pledge([]);var a=y.getByUid(c.uuid);if(a.script&&a.cond){var b;[].concat(a.script.requires).concat(a.script.resources).some(function(a){a=a.url||z.sanitize(a.unsafe_url,a.abs_url);if(a==c.url&&(a=M.getElement(c.uuid,a))&&a.data&&a.data.content)return b=a.data.content,!0});return m.Pledge([b])}n.warn("tree: unable to process ",
a);return m.Breach()}}},settings:function(c,a){var b=m(),e={name:d.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},f;c.complete||!a?f=m.Pledge(Ea.create()):(e.referrer="options.settings",f=m.Pledge());f.done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()}}};n.debug("tree: loading",B,r);return h(B,!0)()}}}(),ra=function(d,m,g){var h=[],k=new C.Script;["author","copyright"].forEach(function(c){k[c]=!1});Object.keys(d).forEach(function(c){var a=d[c],
b;if(m){b={};var e=["textContent","requires","resources"];Object.keys(k).forEach(function(c){-1==e.indexOf(c)&&(w.toType(k[c]),b[c]=a[c])});g?(b.referrer=g,b.length=a.textContent.length):b.code=a.textContent;["requires","resources"].forEach(function(c){b[c]=w.map(a[c],function(b){var d=b.url||z.sanitize(b.unsafe_url,b.abs_url),e=M.getElement(a.uuid,d),f=0,g=null,h=null,k,m,n;e&&e.data&&(e.data.content&&(f=e.data.content.length),h=e.data.sri,g=e.ts,k=e.modified,n=e.data.meta||"text/plain",m="requires"==
c||/text\/.*|application\/(?:x-)?(?:java|ecma)script/.test(n));return{display_url:b.url||b.unsafe_url,url:d,data:{length:f},sri:h,ts:g,mimetype:n,editable:m,modified:k}})});b.origin=v.determineOrigin(a);b.contexter=v.isContexter(a);b.temp_connects=ea.getSessionConnects(a.uuid);c=y.getStorageByUid(a.uuid);b.storage_key_count=Object.keys(c.data).length;b.lastUpdated=a.lastUpdated}else c=v.determineOrigin(a),b={name:a.name,name_i18n:a.name_i18n,uuid:a.uuid,system:a.system,support:!!a.supportURL||c&&
!!c.issue_url,abuse:c&&!!c.abuse_url,contexter:v.isContexter(a),enabled:a.enabled,position:a.position};b.blacklisted=a.evilness>=f.values.script_blacklist_severity;a.evilness&&(b.warnings=S.getWarningsFor(v.determineSourceURL(a)));b.file_url=a.downloadURL||a.fileURL;b.positionof=d.length;b.userscript=!0;a.icon64||a.icon||(b.icon64=rea.extension.getURL("images/txt.png"));a.options&&Object.keys(k.options).forEach(function(c){b[c]=a.options[c]});h.push(b)});return h},V={run:function(d,f){var g=1,h=function(){0==
--g&&(f&&f(),rea.page.reload())};if("config"==d){var k=t.listValues();Object.keys(k).forEach(function(c){c=k[c];-1==c.search(q.CONSTANTS.PREFIX.SCRIPT)&&-1==c.search(q.CONSTANTS.PREFIX.COND)&&-1==c.search(q.CONSTANTS.PREFIX.STORE)&&-1==c.search(q.CONSTANTS.PREFIX.META)&&(g++,t.deleteValue(c).always(h))})}else"factory"==d&&(g++,H.remove_permission().done(h),g++,t.factoryReset().always(h));h()},reset:function(d){V.run(null,d)},factoryReset:function(d){V.run("factory",d)},configReset:function(d){V.run("config",
d)}},Q=function(){var m=function(){rea.runtime.lastError&&void 0},r={init:function(){r.setIcon();var d=f.values.appearance_badge_color||"#ee3131";"#"!==d[0]&&(d="#"+d);rea.browserAction.setBadgeBackgroundColor({color:d})},setIcon:function(g){var h,k;k=null;var c=h=!1;void 0===g||D.get.empty(g)||(h=D.get.blocker(g),c=D.get.forbidden(g));c?(h="_forbidden",k=d.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):h?(h="_blocker",k=d.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):
h=f.values.enabled&&void 0!==g?"":"_grey";n.debug("badge: set icon "+h);h={path:rea.extension.getURL("images/icon"+h+".png")};k={title:k?k:rea.extension.manifest.name};null!=g&&(h.tabId=g,k.tabId=g);try{rea.browserAction.setIcon(h,m),rea.browserAction.setTitle(k)}catch(a){n.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(d){var h=0;"off"==f.values.appearance_badges?h=0:"running"==f.values.appearance_badges?d&&!D.get.empty(d)&&(h=D.get.stats(d).running):"running_unique"==f.values.appearance_badges?
d&&!D.get.empty(d)&&(h=D.get.stats(d,!0).unique):"disabled"==f.values.appearance_badges&&d&&!D.get.empty(d)&&(h=D.get.stats(d).disabled);n.debug("badge: set "+h);h?rea.browserAction.setBadgeText({text:h.toString(),tabId:d}):rea.browserAction.setBadgeText({text:"",tabId:d})}};return r}(),aa=function(){var d=null,f={init:function(){d=t.getValue(q.CONSTANTS.STORAGE.BEGGING,null);var g,h=Date.now();d?(g=t.getValue(q.CONSTANTS.STORAGE.LAST_START,0))&&12096E5<h-g&&(d.later={type:"after_pause",ts:h},f.save()):
(d={first_run:{type:"from_init",ts:h}},f.save())},save:function(){t.setValue(q.CONSTANTS.STORAGE.BEGGING,d)},needed:function(){var f=Date.now(),h=d.first_run?d.first_run.ts+12096E5<f:!0,k=!d.hide,c=!d.contributed,f=d.later?d.later.ts+12096E5<f:!0;if(!q.RUNTIME.DOLPHIN&&h&&k&&c&&f)return d.later?"l":"i"},clicked:function(d,f,k){L.tG("clicked",d,f+k)},dialog:{shown:function(g){var h=Date.now();d.dialog={ts:h,extra:g};f.save();L.tG("dialog")}},button:function(){var g={};["contributed","later","hide"].forEach(function(h){g[h]=
function(g,c){var a=Date.now();d[h]={ts:a,type:g,extra:c};f.save();L.tG("button",h)}});return g}()};return f}(),ja=function(){var d=function(a,b){n.debug(a,b);if(b&&a.menuItemId){var c=y.getByUid(a.menuItemId);c&&c.script?xa.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},c.script,!0).then(function(c){var d=m();c.method="executeScript";a.frameUrl?c.url=z.woHash(a.frameUrl):c.topframe=!0;rea.tabs.sendMessage(b.id,c,d.resolve);return d.promise()}):n.debug("ctxm: unable to find script "+a.menuItemId,
a,b)}},f=[],g=null,h=!1,k=function(a){var b=[];w.each(a,function(a){var c=m();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:g,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){c.resolve()});f.push(a.uuid);b.push(c.promise())});return m.when(b)},c=function(){var a=m();rea.contextMenus.removeAll(function(){g=null;a.resolve()});return a.promise()},a=function(){var a=m();c().then(function(){g=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",
type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},b=function(){var b=ca.getContexters(0,null);if(b.length){var d;d=g?m.Pledge():a();return d.then(function(){return k(b)})}return c().then(e.clean)},e={init:function(){rea.contextMenus.supported&&(e.clean().then(b).then(function(){h=!0}),rea.contextMenus.onClicked.addListener(d))},clean:function(){var a=m();f.forEach(function(a){rea.contextMenus.remove(a)});f=[];a.resolve();return a.promise()},
onScriptsChanged:function(){if(rea.contextMenus.supported&&h)return e.clean().then(b)},getContexterCount:function(){return f.length}};return e}(),da=function(){var d={},m={},g=("TM_"+w.createUUID().substr(0,5)).toLowerCase(),h=["x-webkit-csp","x-content-security-policy","content-security-policy"],k=function(a,b){var c,d,e,f,g=a.split(";");g.forEach(function(a,b){0===a.search(/^\s*script-src /)?d=b:0===a.search(/^\s*default-src /)&&(e=b)});var h,k;void 0!==e&&void 0===d&&(c=!0,g.push(g[e].replace(/default-src /,
"script-src ")),d=g.length-1);void 0!==d&&(k=!1,h=g[d],-1==h.search(/'unsafe-eval'/)&&(k=!0,h=h.replace(/script-src /,"script-src 'unsafe-eval' ")),-1!=h.search(/'none'/)&&(k=!0,h=h.replace(/ 'none'/,"")),q.RUNTIME.FIREFOX&&(-1==h.search(/'unsafe-inline'/)&&(k=f=!0,h=h.replace(/script-src /,"script-src 'unsafe-inline' ")),-1==h.search(/'strict-dynamic'/)&&-1!=h.search(/ '(nonce|sha[0-9]+)-[^\']+'/)&&(k=!0,h=h.replace(/ '(nonce|sha[0-9]+)-[^\']+'/g," *"))),k&&(g[d]=h,c=!0));void 0!==e&&(k=!1,h=g[e],
f&&-1!=h.search(/ 'self'/)&&(k=!0,g[e]=h.replace(/default-src /,"default-src blob: data: ")),k&&(c=!0));return c?g.join(";"):null},c=function(a,b){var c,d=a.url;Object.keys(b).forEach(function(a){var e=b[a];w.each(e.rules,function(a,b){var f,g;if((f=a.selector)&&(g=a.action)){var h,k=e.id+"/"+b;(h=J.items.regexp.get(k))||(h=v.regexify({inc:f.include,match:f.match,exc:f.exclude}),J.items.regexp.set(k,h));if(v.validUrl(d,h)){g.cancel&&(n.debug("webRequest: request was canceled by script "+e.uuid,d,
a,e),e.callback&&e.callback({type:"cancel",details:{rule:a,url:d}}),c={cancel:!0});if(g.redirect){var p,l,m,r;g.redirect.url?p=g.redirect.url:g.redirect.regex&&(l=g.redirect.regex.from)&&(m=g.redirect.to)&&(r=d.match(l,m))&&(r.shift(),p=d,r.concat(["","",""]).forEach(function(a,b){p=p.replace("$"+b,a||"")}));f=function(b){n.warn("webRequest: error while request redirect by script "+e.uuid,d,a,e);e.callback&&e.callback({type:"redirect",message:"error",details:{description:b,rule:a,url:d,redirect_url:p}})};
if(!p){f("unable to determine the redirect URL");return}p=z.woHash(p);U.isAllowed(p)?v.scriptWillRun(e.uuid,p)?(n.debug("webRequest: request was redirected by script "+e.uuid,d,p,a,e),e.callback&&e.callback({type:"redirect",details:{rule:a,url:d,redirect_url:p}}),c={redirectUrl:p}):f("the redirect URL needs to be included by the scripts @include or @match tag"):f("the redirect URL is filtered by the security settings")}if(c)return!1}}})});return c},a=function(a){var b=[],c=a.requestHeaders||[],d,
e,f={},h=new RegExp("^"+g),c=c.filter(function(c){if(c.name&&0==c.name.search(h))e=c.name.replace(h,""),f[e.toLowerCase()]=!0,"internal"==e?m[a.requestId]=c.value:c.value&&b.push({name:e,value:I.decodeS(c.value)}),d=!0;else return!0});if(d)return{requestHeaders:c.filter(function(a){return!a.name||!f[a.name.toLowerCase()]}).concat(b)}},b=function(a){if(F.late)if("main_frame"==a.type){if(D.events.reset(a.tabId,!0),0<a.tabId&&"POST"!=a.method&&"auto"==f.values.scriptUrlDetection&&oa.isScriptUrl(a.url))return v.installFromUrl(a.url,
{},{silent_fail:!0}).fail(function(b){n.info("webRequest: user script detected @ "+a.url+" was invalid",b?b.messages:"");rea.tabs.update(a.tabId,{url:a.url+"#bypass=true"},function(){})}).done(function(){q.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},function(b){b.forEach(function(b){b.id===a.tabId&&rea.tabs.update(b.id,{url:b.url},function(){})})})}),q.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else{var d,e;if((d=D.get.requests(a.tabId,a.frameId))&&(e=c(a,d)))return e}else F.registerLateCallback(function(){b(a)})},
e=function(a,b){if(F.late){var c=a.responseHeaders||[];if("xmlhttprequest"==a.type){var g,l,n;(g=m[a.requestId])&&delete m[a.requestId];(l=d[a.requestId])&&delete d[a.requestId];if(g&&(q.XMLHTTPREQUEST.COOKIE_PASSTHROUGH||c.forEach(function(a){a.name&&a.value&&-1!=a.name.toLowerCase().indexOf("set-cookie")&&(c.push({name:"tm-setcookie"+rea.runtime.short_id.toLowerCase(),value:a.value}),n=!0)}),l&&(c.push({name:"tm-finalurl"+rea.runtime.short_id.toLowerCase(),value:l}),n=!0),n))return{responseHeaders:c}}else{var t,
u,w,x=q.OPTIONS.HAS_CSP&&"yes"==f.values.webrequest_fixCSP;c.some(function(a){if(a.name)return a=a.name.toLowerCase(),u|="location"==a,x&&(w|=-1!=h.indexOf(a)),u});if(!u){(g=D.events.response(a.tabId,a.frameId,a.url))&&w&&c.forEach(function(b,d){if(b.name&&b.value){var e=b.name.toLowerCase();-1!=h.indexOf(e)&&(e=k(b.value,a))&&(t=!0,c[d]={name:b.name,value:e})}});var v;q.RUNTIME.FAST_EXEC_SUPPORT&&-1!=["instant"].indexOf(f.values.runtime_inject_mode)&&(v=D.events.run(a.tabId,a.frameId,null,a.url))&&
(l=z.parse(a.url),l=l.pathname+l.search,l="TM_"+rea.runtime.short_id+I.Base64.encode(l.length+l).substr(0,255).replace(/[#=\/]/g,"_")+Date.now(),v=ca.answer(v,a.url),v=JSON.stringify(v),v=new Blob([v],{type:"binary/octet-stream"}),v=URL.createObjectURL(v),D.set.objurl(a.tabId,a.frameId,v),c.push({name:"set-cookie",value:l+"="+window.encodeURIComponent(v)+"; max-age=15;"}),t=!0);if(g&&!b&&rea.webRequest.filterResponseData&&q.OPTIONS.HAS_CSP&&"yes"==f.values.webrequest_fixCSP&&"yes"==f.values.webrequest_fixContentCSP&&
-1!=["main_frame","sub_frame"].indexOf(a.type)){var y;c.some(function(a){if(a.name&&a.value&&"content-type"==a.name.toLowerCase()&&"text/html"==a.value.split(";")[0].toLowerCase().trim())return y=!0});if(y){var C=rea.webRequest.filterResponseData(a.requestId);C.ondata=function(b){var c=(new TextDecoder("x-user-defined")).decode(b.data,{stream:!0}),d=new RegExp('(<head>[\\s\\S]*)(<meta[^>]+http-equiv="(?:'+h.join("|")+')"[^>]*>)([\\s\\S]*?<\\/head>)',"i"),e,c=c.replace(d,function(b,c,d,f){return c+
d.replace(/(content=")([^">]+)(")/,function(b,c,d,f){if(b=k(d||"",a))e=!0;return c+(b||d)+f})+f});e?C.write(I.str2arrbuf(c)):C.write(b.data);C.disconnect();C=null};C.onstop=function(){C&&C.disconnect()}}}if(t)return{responseHeaders:c}}}}else F.registerLateCallback(function(){e(a,!0)})},l=function(a){d[a.requestId]=a.redirectUrl},t=function(a){F.late?a.fromCache&&D.events.response(a.tabId,a.frameId,a.url):F.registerLateCallback(function(){t(a)})},u=function(a){D.events.reset(a.tabId,!0)};return{getPrefix:function(){return g},
init:function(c){try{var d;d=q.RUNTIME.EDGE?["http://*/*","https://*/*"]:["http://*/*","https://*/*","ftp://*/*","file:///*"].concat(q.RUNTIME.WEBREQUEST_WEBSOCKET?["ws://*/*","wss://*/*"]:[]);c?(rea.webRequest.onBeforeRequest.addListener(b,{urls:d,types:["main_frame","sub_frame","script","xmlhttprequest"].concat(q.RUNTIME.WEBREQUEST_WEBSOCKET?["websocket"]:[])},["blocking"]),rea.webRequest.onHeadersReceived.addListener(e,{urls:d,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"]),
q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&rea.webRequest.onBeforeRedirect.addListener(l,{urls:d,types:["xmlhttprequest"]},[]),rea.webRequest.onResponseStarted.addListener(t,{urls:d,types:["main_frame","sub_frame"]},[]),rea.webRequest.onErrorOccurred.addListener(u,{urls:d,types:["main_frame"]})):q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=f.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(a,{urls:d,types:["xmlhttprequest"]},["blocking","requestHeaders"]);rea.webRequest.handlerBehaviorChanged()}catch(g){n.warn("webRequest: error initializings",
g.message)}},scripts:{set:function(a,b,c,d,e){var f=[];d.forEach(function(a){var b="string"===typeof a.selector?{include:[a.selector]}:a.selector;["include","match","exclude"].forEach(function(b){"string"===typeof a.selector[b]&&(a.selector[b]=[a.selector[b]])});var c=a.action;if("string"===typeof c){var d=c,c={};c[d]=!0}"string"===typeof a.action.redirect&&(a.action.redirect={url:a.action.redirect});f.push({selector:b,action:c})});D.set.requests(a,b,c,{id:c+"@"+a+":"+b+"#"+Date.now(),rules:f,uuid:c,
callback:e})}}}}(),F={late:!1,callbacks:[],init:function(){},registerLateCallback:function(d){n.debug("toea: register callback");F.callbacks.push(d)},setReady:function(){n.debug("toea: run "+F.callbacks.length+" callbacks");F.late=!0;for(var d=0;d<F.callbacks.length;d++)F.callbacks[d]();F.callbacks=[]}},Fa=function(){var d=!1,f=null,g=function(){d||(n.debug("Unloader.onbeforeunload()"),f&&f(),d=!0)};return{init:function(d){f=d;window.addEventListener("beforeunload",g,!1)}}}(),va=function(){var v=
null,r=rea.extension.manifest.version,g=null,h=!1,k=!1,c=function(){if(F.late){var a="version="+r+"&ext="+rea.runtime.short_id+"&updated=true",b;h?(b="http://tampermonkey.net/installed.php?"+a,k=!0):(a+="&old="+g,b="http://tampermonkey.net/changelog.php?"+a);"off"!=f.values.notification_showUpdate&&("notification"==f.values.notification_showUpdate?R.showUpdate(d.getMessage("Updated_to__0version0",r),d.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),function(a){a.clicked&&
rea.tabs.create({url:b},function(){})}):"changelog"==f.values.notification_showUpdate&&(k||(b+="&intr=true"),k=!0,rea.tabs.create({url:b,active:k},function(){})))}else F.registerLateCallback(c)},a=function(){var a=null,b,c=m(),d=function(){b&&(b=null,c.resolve(!!a))};b=window.setTimeout(d,300);rea.idle.queryState(q.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});return c.promise()},b=function(a){F.late?(n.debug("upd: onInstalled",a),a||(a={reason:"mandatory_argument_is_not_set"}),"chrome_update"==
a.reason?L.tB({updated:!0}):"install"!=a.reason&&"update"!=a.reason||p.scheduleNotification(a.previousVersion,"install"==a.reason)):F.registerLateCallback(function(){b(a)})},e=function(){var a=m(),b=function(){var b=Date.now(),c=t.getValue(q.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=q.MISC.DISTURBANCE_ALLOWED;n.debug("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};F.late?b():F.registerLateCallback(b);return a.promise()}(),l=function(){var b=!1,d=!1;a().then(function(a){d=
a;return e}).then(function(a){b=a}).always(function(){k=!d||b;c();u=!0})},w=null,u=!1,p={scheduleNotification:function(a,b){u||(g=a,h|=b,w&&window.clearTimeout(w),w=window.setTimeout(l,1E3))},updateAvailable:function(){return v}};rea.runtime.onInstalled.addListener(b);rea.runtime.onUpdateAvailable.addListener(function(a){n.info("An update to version",a.version,"is available");v=a.version;window.setTimeout(function(){R.show(d.getMessage("Update"),d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",
rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){F.registerLateCallback(function(){t.setValue(q.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return p}(),Ga=function(d){(function(){var n=m();"toggle-enable"==d?(f.values.enabled=!f.values.enabled,n.resolve()):rea.tabs.getSelected(null,function(f){var h;"open-dashboard"==d?h=rea.extension.getURL("options.html")+"#nav=dashboard":"open-dashboard-with-running-scripts"==d?h=rea.extension.getURL("options.html")+
"#nav=dashboard&filter="+encodeURIComponent(f.url):"open-new-script"==d&&(h=rea.extension.getURL("options.html")+"#url="+I.Base64.encode(f.url)+"&nav=new-user-script");n.resolve(h?{url:h,active:!0,parent:f}:null)});return n.promise()})().then(function(d){d&&rea.tabs.create(d)})},sa=function(){var d=[],m=function(a,b,c){F.late?("auto"==f.values.scriptUrlDetection&&oa.isScriptUrl(c.url)&&v.installFromUrl(c.url,{},{silent_fail:!0}),c.url?"loading"==b.status?D.events.loading(c.id,0,c.url):"complete"==
b.status&&D.events.complete(c.id,0,c.url):n.warn("tabUpdates: no tab url set! ",c),d.forEach(function(a){a({reason:"updated",status:b.status},c)})):window.setTimeout(function(){m(a,b,c)},100)},g=function(a,b){X[a]&&(X[a].onClose(),delete X[a]);D.events.remove(a);d.forEach(function(b){b({reason:"removed"},{id:a})})},h=function(a,b){g(b,{});Q.setIcon(a);Q.setBadge(a);d.forEach(function(b){b({reason:"replaced"},a)})},k=function(a){D.events.commited(a.tabId,a.frameId,a.url);0===a.frameId&&d.forEach(function(b){b({reason:"commited"},
{url:a.url,id:a.tabId})})},c={init:function(){rea.tabs.onUpdated.addListener(m);rea.tabs.onRemoved.addListener(g);rea.tabs.onReplaced.addListener(h);rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(k)},openAndWatch:function(a,b){var d=null,f=function(a,g){null!==d&&g.id===d&&(-1!=["updated","commited"].indexOf(a.reason)?b(g):"removed"==a.reason&&(c.removeListener(f),b()))};rea.tabs.create(a,function(a){d=a.id;b(a)});c.addListener(f);return{cancel:function(){c.removeListener(f);
null!==d&&(rea.tabs.remove(d,function(){}),d=null)}}},addListener:function(a){d.push(a)},removeListener:function(a){var b;d&&-1<(b=d.indexOf(a))&&d.splice(b,1)}};return c}(),ya=function(){var d="temporary"==f.values.incognito_mode&&rea.extension.inIncognitoContext;t.setTemporary(d);d&&(f.values.native_import=!1,f.values.sync_enabled=!1,f.values.scriptUpdateCheckPeriod=0,f.values.sync_type=0,f.values.statistics_enabled=!1)},Ha=function(){n.set(f.values.logLevel);d.setLocale(f.values.i18n);O.setPath(f.values.native_import_path);
ma=Registry.get("xmlhttprequest",q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=f.values.webrequest_modHeaders?da.getPrefix():null,q.RUNTIME.FIREFOX);ka=ma.run;L.init("bg",rea.extension.manifest.version);L.setEnabled(f.values.statistics_enabled);D.listeners.add.onReset(function(d,f){ba.clearByTabId(d);y.removeStorageListeners({tabid:d},!1);f||Q.setIcon(d)});var m=function(d){rea.tabs.get(d,function(f){!rea.runtime.lastError&&f&&(Q.setIcon(d),Q.setBadge(d))})};D.listeners.add.onCommited(m);D.listeners.add.onCompleted(m);
D.listeners.add.onCompleted(ea.purgeAppeals);D.listeners.add.onRemoved(ea.purgeAppeals);K.init().done(function(d){d&&K.sync()});U.init();S.init();y.init();m=function(){H.set_mode(f.values.downloads_mode);H.set_whitelist(f.values.downloads_extension_whitelist)};m();H.config_changed_listener=m;qa.init();da.init();ja.init();aa.init();Z.init()},I,ka,ma,na,C,G,fa;init=function(){F.init();da.init(!0);sa.init();wa.init();rea.commands.supported&&rea.commands.onCommand.addListener(Ga);Fa.init(function(){K.finalize()});
I=Registry.get("convert");na=Registry.get("compat",q);C=Registry.get("parser");G=Registry.get("syncinfo",sa);fa=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});t.init().then(function(){return Ba()}).then(function(){return f.init()}).then(function(){cfgo=f;ya();Ha();Da();Q.init();window.setTimeout(Z.check,1E4);n.debug("Listeners registered!");window.setTimeout(F.setReady,
1);if(fa&&Registry.isDevVersion("test")){var d=fa.framework.prepare(v.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION);d&&n.error(d)}})};init()}});
